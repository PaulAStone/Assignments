---
title: "Among Site (Beta) Diversity"
author: "Z620: Quantitative Biodiversity, Indiana University"
date: "February 6, 2015"
header-includes:
   - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

## OVERVIEW
In this exercise, you will explore between-site biodiversity, also known as beta ($\beta$) diversity. 
First, you will learn how to formally quantify $\beta$-diversity.
Second, you will learn how to visualize $\beta$-diversity using cluster analysis, ordination, and heatmaps. 
Last, you will be introduced to some multivariate techniques to test hypotheses about $\beta$-diversity. 

## 1) SETUP
### Retrieve and Set Your Working Directory

```{r, results = 'hide'}
rm(list=ls())
getwd()
setwd("~/GitHub/QuantitativeBiodiversity/Assignments/Beta")
```

### Load Packages 

From last week's exercises, you should now be familiar with some of the features in the R package `vegan`.
We will be using this pacakge again; please load it now.

```{r, results = 'hide', message = FALSE, warning = FALSE} 
require("vegan")
```

## 2) LOADING DATA
We will again be using the BCI data set contained in `vegan` for part of this week's exercise. 
In addition, we will be using environmental data for the BCI plots. 
Your Beta folder has soil data for each of the BCI plots (bci.soil.txt).
Let's go ahead and import all of these data now.

```{r}
data(BCI)                                   # BCI Tree Abundance (vegan)
BCI.soil <- read.delim("./bci.soil.txt")    # BCI Soil Data (your working directory)
```

## 3) Exploring $\beta$-Diversity
Last week, we learned about $\alpha$-diversity, where we calculated things like species richness and evenness. 
These metrics are great for assessing the diversity of a single sample, but overlook spatial and temporal heterogeneity.
$\beta$-diversity is a measure of between-habitat diversity, or the difference in species composition between two or more samples. 

### BCI Species Richness
To illustrate the importance of $\beta$-diversity, let's go back to the BCI dataset and examine tree richness among all sites. 
First, let's calculate richness for the BCI sites:

```{r}
BCI.S <- rowSums(BCI > 0) * 1
```

Now, we are going to visualize tree species richness by ploting sites based on their locations.
We are going to color-code the sites based on tree species richness using a **heatmap**.
In R there are a few tools that allow you to make color pallets. 
Here we are going to use `terrain.colors` but you can learn about other colors families by looking at the `Pallettes` help file: `help(Pallettes)`.
Let's start by making a color pallette for Richness (S):

```{r}
BCI.S.color <- rev(terrain.colors(max(BCI.S) + 1))
```

Notice that we reversed ('rev()') the sequence of colors in the pallette, this was done to make the color ranges more intuitive (darker colors correspond with larger values of S). 
Also, notice that we have to define the number of colors in each pallette. 
Here we used one more than the max values for S. 
This is done to deal with any 0s in our data.

Let's start by plotting tree richness for each plot at BCI. 
But how do we know how these sites are arranged? 
Well lucky for us, the BCI soil dataset includes standardized XY-coordinates for each plot:

```{r}
head(BCI.soil, n = 2L)    # What does n = 2L do?
```

Here we are going to plot sites in a standardized XY-coordinate space and use our heatmap color to display tree species richness for each of the 50 sites.
In addition, we will add a legend to the plot so that readers understand the heatmap scale.
This plot also includes a bunch of new commands that are important for producing effective figures.
To learn more about these commands, you can modify them or use the `help()` files. Take a few minutes to investigate.

```{r, fig.width=6, fig.height=3.5}
# BCI Tree Richness
par(mar=c(4,4,3,4) + 0.1, xpd=TRUE) # xpd allows the legend to appear outside of the plot
plot(BCI.soil$x, BCI.soil$y, asp = 1, pch = 22, cex = 4, las = 1, 
     bg = BCI.S.color[BCI.S + 1], 
     xlim = c(0, 1000), ylim = c(0, 500), main = "BCI Richness (S)", 
     xlab = "X-Coordinate (m)", ylab = "Y-Coordinate (m)")
text(BCI.soil$x, BCI.soil$y, BCI.S, cex = 0.5, col = "red")
legend("topright", inset = c(-0.2, 0), pch = 22, pt.cex = 3, title = "S", 
       bty ='n', legend = seq(0, 150, 25), pt.bg = BCI.S.color[seq(1, 151, 25)])
```

**Questions**

A. What do you notice when you compare all 50 sites? 

```
    Please Provide Answer Here
```

B. Is this a good way to compare the sites?

```
    Please Provide Answer Here
```

C. What does this method of comparing sites miss?

```
    Please Provide Answer Here
```

### BCI Individual Tree Abunance
Patterns in richness may obscure differences in tree species composition across the BCI landscape.
To investigate this, let's just focus on the abundance of a specific tree: the Prioria tree. 

First, let's generate a heatmap pallette for tree abundance.
We will plot the abundance data in the same way we did for richness.

```{r}
BCI.N.color <- rev(terrain.colors(41))
```


```{r, fig.width=6, fig.height=3.5}
# BCI Prioria Abundance
par(mar=c(4,4,3,4) + 0.1, xpd=TRUE)
plot(BCI.soil$x, BCI.soil$y, asp = 1, pch = 22, cex = 4, las = 1, 
     bg = BCI.N.color[BCI$Prioria.copaifera + 1], 
     xlim = c(0,1000), ylim = c(0, 500), main = "Prioria Abundance (N)", 
     xlab = "X-Coordinate (m)", ylab = "Y-Coordinate (m)")
text(BCI.soil$x, BCI.soil$y, BCI$Prioria.copaifera, cex = 0.5, col="red")
legend("topright", inset=c(-0.2, 0), pch=22, pt.cex=3, bty='n',
       title="N", legend=seq(0, 40, 10), pt.bg = BCI.N.color[seq(1, 41, 10)])
```

**Questions**

D. What do you observe across BCI?

```
    Please Provide Answer Here
```

E. How does this compare to the patterns of species richness?

```
    Please Provide Answer Here
```

### Doubs River Fish Abundance
In contrast, some datasets might show variation in alpha diversity across samples or sites. 
The doubs data set in the `ade4` package has fish abundances, environmental variables, and spatial cooridinates for 30 sites in the Doubs River (runs near the France-Switzerland boarder in the Jura Mountains). 
This data set has been used to show that fish communities can be a good indicator of ecological zones in rivers and streams. 
We will use this data for similar purposes throughout today's exercise.

First we need to import the data from the `ade4` package. 
We can also look at the dataset to see what it contains. 
We will use the `str()` function to see what information is in the dataset.

```{r}
require(ade4)
data(doubs)
str(doubs, max.level = 1)                 
```

Notice that the doubs data set is actully a list with 4 components (elements).
Lists might be new data structures for you. 
In R, a list is an ordered collection of objects. 
The first component of the doubs list is the environmental data for each of the 30 sites (doubs$env). 
There are 11 environmental variables in this dataset. 
See the help file for more information on each (including units). 
The second component are the abundances at each site for 27 fish species. 
The third component has the xy spatial coordinates for each site. 
The last component contains the names of each fish species. 

Let's plot fish richness in these stream communities.
We will first need to calculate richness and define our color pallettes.
Once we have these items we can plot stream fish richness in a similar fashion as we did with BCI tree communities.
Below are three plots similar to the BCI plots we created above.
These plots show richness of fish at all sites in the Doubs River.

```{r, fig.width=5, fig.height=4.5, echo=TRUE}
# Stream Fish
par(mar = c(4, 4, 3, 5) + 0.1, xpd = TRUE)    
spa.S <- specnumber(doubs$fish)               
spa.S.color <- rev(terrain.colors(31))    # Define Richness Color Pallette
spa.N.color <- rev(terrain.colors(7))     # Define Abundance Color Pallette

# Stream Fish Richness
plot(doubs$xy, asp = 1, type = 'l', col = "light blue", lwd = 10, las = 1, 
     xlim = c(0,280), ylim = c(0,280), main = "Fish Richneses (S)", 
     xlab = "X-Coordinate (km)", ylab = "Y-Coordinate (km)")
points(doubs$xy, pch = 22, cex=2, bg = spa.S.color[spa.S + 1])
text(doubs$xy, as.character(spa.S), cex = 0.5, col="red")
text(150, 0, "Upstream", cex = 1, col = "red")
text(48, 114, "Downstream", cex = 1, col = "red")
legend("topright", inset=c(-0.25, 0), pch = 22, pt.cex = 2, bty = 'n',
       title = "S", legend = seq(0, 30, 10), pt.bg = spa.S.color[seq(1, 31, 10)])
```

Notice that the code we used here is almost identical to that we used with the BCI plots.
Though creating a single figure in R may seem like a lot of work, it is beneficial when making multiple plots because you can recycle code easily.
However, sometimes there are slight variations (e.g., the blue line in the stream plot).

Below are the plots for two individual fish species in the Doubs River.
You should be able to code this with ease using the Stream Fish Richness plot code and the BCI abundance plot code. 
You can try this on your own time, but here we are just going to provide the plots for you.

```{r, fig.width=8, fig.height=3.75, echo=FALSE}
# Define Plot Parameters
par(mfrow = c(1,2), mar = c(4, 4, 3, 4) + 0.1, xpd = TRUE)    

# Brown Trout Abundance
plot(doubs$xy, asp = 1, type = 'l', col = "light blue", lwd = 10, las = 1, cex.axis = 0.75, 
     xlim = c(0, 280), ylim = c(0, 280),main = "Brown Trout Abundance (N)", 
     xlab = "X-Coordinate (km)", ylab = "Y-Coordinate (km)")
points(doubs$xy, pch = 22, cex=2, bg = spa.N.color[doubs$fish$Satr + 1])
text(doubs$xy, as.character(doubs$fish$Satr), cex = 0.5, col="red")
text(150, 0, "Upstream", cex=1, col="red")
text(48, 114, "Downstream", cex=1, col="red")
legend("topright", inset=c(-0.25, 0), pch = 22, pt.cex = 2, bty = 'n',
       title = "N", legend = seq(0, 6, 2), pt.bg = spa.N.color[seq(1, 7, 2)])

# Common Roach Abundance
plot(doubs$xy, asp = 1, type = 'l', col = "light blue", lwd = 10, las = 1, cex.axis = 0.75, 
     xlim = c(0, 280), ylim = c(0, 280),main = "Common Roach Abundance (N)", 
     xlab = "X-Coordinate (km)", ylab = "Y-Coordinate (km)")
points(doubs$xy, pch = 22, cex=2, bg = spa.N.color[doubs$fish$Ruru + 1])
text(doubs$xy, as.character(doubs$fish$Ruru), cex = 0.5, col="red")
text(150, 0, "Upstream", cex = 1, col = "red")
text(48, 114, "Downstream", cex = 1, col = "red")
legend("topright", inset=c(-0.25, 0), pch = 22, pt.cex = 2, bty = 'n',
       title = "N", legend = seq(0, 6, 2), pt.bg = spa.N.color[seq(1, 7, 2)])
```

F. How does this dataset differ from the BCI data? 

```
    Please Provide Answer Here
```

G. Is richness the most appropriate tool to compare communities, why or why not?

```
    Please Provide Answer Here
```

H. What about other $\alpha$-diversity measures?

```
    Please Provide Answer Here
```

This week we are going to compare the diversity of communities across sites. 
We will start by comparing diversity across sites. 

## 4) Quantifying $\beta$-Diversity
The previous section was intended to visually demonstrate that aggregate measures of biodiversity -- like richness -- do not always capture meaningful differences in species composition among sites. 
In this section, we will introduce some of the ways in which $\beta$-diversity is directly quantified. 

### a) Turnover
One way to think about $\beta$-diversity is the change in communities over time or space. 
This concept is generally refered to as *turnover*.
Turnover is defined as the rate or magnitude of change in species composition in time or along a predefined spatial or environmental gradient. 

We can calculate turnover with the following equation:
$turnover = \frac{b + c}{S_1 + S_2}$
where b = the number of speces present in only the first sample; c = the number of species present in only the second sample; $S_1$ = the total number of species in the first sample; and $S_2$ = the number of species in the second sample. 

In R, we could write this as a function as follows:

```{r}
turnover <- function(site1 = " ", site2 = " "){
  site1 = subset(site1, select = site1 > 0)               # Removes absences
  site2 = subset(site2, select = site2 > 0)               # Removes absences
  b  = length(setdiff(colnames(site1), colnames(site2)))  # Number of unique in 1st
  c  = length(setdiff(colnames(site2), colnames(site1)))  # Number of unique in 2nd
  s1 = length(site1)                                      # Number of species in 1st 
  s2 = length(site2)                                      # Number of species in 2nd 
  t  = round((b + c)/(s1 + s2), 3)                        # Calculats turnover to three decimals
  return(t)                                               # Returns turnover
}
```

We can now use this function to calculate turnover between any two points in time or space.

```{r}
turnover(doubs$fish[1,], doubs$fish[2,]) 
turnover(BCI[1,], BCI[2,])
```

### b) $\beta$-Diversity
Another classic measures of $\beta$-diversity was developed by Whittaker (1960):
$\beta_{W} = \frac{S}{\bar{\alpha}} - 1$ 
where S = the total number of species recorded in a system and $\bar{\alpha}$ is the average sample richness.
Subtracting 1 scales the results from 0 - 1.

Again, we can write this as a function in R:

```{r}
beta.w <- function(site1 = "", site2 = ""){
  site1 = subset(site1, select = site1 > 0)               # Removes absences
  site2 = subset(site2, select = site2 > 0)               # Removes absences
  gamma = union(colnames(site1), colnames(site2))         # Gamma species pool
  s     = length(gamma)
  a.bar = mean(c(specnumber(site1), specnumber(site2)))
  b.w   = round(s/a.bar - 1, 3)
  return(b.w)
}
```

$\beta_{w}$ ranges from 0 (minimum $\beta$-diversity) to 1 (maximum $\beta$-diverstity).

Using our new R function, we can now calculate $\beta_{w}$ between two sites:
```{r}
beta.w(doubs$fish[1, ], doubs$fish[2, ])
beta.w(BCI[1,], BCI[2,])
```

These measures of $\beta$-diversity are useful when comparing two sites.
However, we often want to compare multiple sites at the same time. 

### c) Measures of Compositional Similarity
When comparing multiple communities, measures of resemblance (similarity) are the most appropriate way to compare communities. 
This is because we can use our site-by-species matrix to generate another ecological data structure: the **Resemblance Matrix**.
The resemblance matrix is a diagonal matrix comprised of all pair-wise similarities between a group of objects. 
In ecology, these similarity measures can either be based on incidence (presence-absence; qualitative) data, or abundance (absolute or total; quantitative) data. 
Here, we will use common notations when refering to these measures.
For reference, all notations will follow that of Legendre & Legendre 2012. 

### i.  Incidence-Based

\begin{center}
\begin{tabular}{ m{2.5cm} m{5.5cm} m{6.5cm} }
  \textbf{Index} & \textbf{Equation} & \textbf{Properties} \\
  \hline \hline \\ [-1.5ex]
  Jaccard & 
  $S_7 = \frac{a}{a+b+c}$ & 
  Compares the number of shared species to the number of species in the combined assemblages  (global view ) \\
  \\ [-1.5ex]
  Sørensen & 
  $S_8 = \frac{2a}{(2a+b+c)}$ & 
  Compares the number of shared speces to the mean number of species in a single assemblage (local view) \\
  \\ [-1.5ex]
  \hline
  \end{tabular}
  \end{center}

Where a = the number of shared speces, b = the number of unique species in the first assemblage, and c = the number of unique species in the second assemblage.

I. What are the differences between these two measures, and Why might you be interested in using one over the other?

```
    Please Provide Answer Here
```

We should note that there are other measures (including: Ochiai, Kulczynski-Cody, ...).
See Table 6.1 in Magurran & McGill 2011, or Table 7.2 in Legendre & Legendre 2012 for more details. 
Also, it should be noted that these equations calculate similarity, but can be converted to dissimilarity, or distance.
In `vegan`, distances are calculated as `D = 1 - S`; however, this conversion may not preserve Euclidean distance.
See Table 7.2 in Legendre & Legendre 2012 for more information.

### ii.  Abundance-Based

\begin{center}
\begin{tabular}{ m{2.5cm} m{5.5cm} m{6.5cm} }
  \textbf{Index} & \textbf{Equation} & \textbf{Properties} \\ 
  \hline \hline \\ [-1.5ex]
  \raggedright Bray-Curtis Dissimilarity &
  $D_{14} = \frac{\sum\limits_{j=1}^{p} \left|{y_{1j} - y_{2j}} \right|}{\sum\limits_{j = 1}^{p}\left(y_{1j} + y_{2j}\right)}$  &
  A quantitative version of the Sørensen index. Semimetrix. Generally used as an overall similarity measure. Also known as the percentage difference \\
  \\ [-1.5ex]
  \raggedright Morisita-Horn &
  $S_{MH} = \frac{2 \sum\limits_{j=1}^{p} y_{1j}y_{2j}}{\left(\sum\limits_{j=1}^{p}y_{1j}^{2} + \sum\limits_{j=1}^{p} y_{2j}^{2}\right)}$ &
  Dominated by the most abundant species in each site. Resistant to undersampling (no equivalent in Legendre and Legendre) \\
  \\ [-1.5ex]
  Chord Distance & 
  $D_3 = \sqrt{2\left(1 - \frac{\sum\limits_{j=1}^{p}y_{1j} \cdot  y_{2j}}{\sum\limits_{j=1}^{p}y_{1j}^{2} \cdot \sum\limits_{j=1}^{p} y_{2j}^{2}}\right)}$ &
  Range: 0 to $\sqrt{2}$ (two sites share the same species in the same proportions to no species in common) \\
  \\ [-1.5ex]
  \raggedright Chi-Squared Distance & 
  $D_{16} = \sqrt{\sum\limits_{j = 1}^{p} \frac{1}{y_{+j}/y_{++}} \left( \frac{y_{1j}}{y_{1+}} - \frac{y_{2j}}{y_{2+}} \right)^2}$ &
  Used to compute the association between the rows and columns of a frequency table. Preserved in correspondence analysis.  \\
  \\ [-1.5ex]
  \hline
  \end{tabular}
  \end{center}

Where $y_{1j}$ is the abundance of each species (1:p) in community 1 and $y_{2j}$ in community 2, $y_{1+}$ is the sum of abundances in community 1 and $y_{2+}$ in community 2, $y_{++}$ is the sum of all abuncances at all sites, $y_{+j}$ is the sum of abundances of the $j^{th}$ species across communities, and $y_{ij}/y_{i+}$ is the relative abundances at site $i$. 

It should be noted that many of these distances are not Euclidean. 
See Table 7.3 in Legendre & Legendre 2012 for more information.

### iii.  Other Measures (may not be appropriate for species abundaces)

Euclidean Distance: 
$D_{1} = \sqrt{\sum\limits_{j =1}^{p} \left( y_{1j} - y_{2j} \right)^{2}}$

Manhattan Metric: 
$D_{7} = \sum\limits_{j = 1}^{p} \left| y_{ij} - y_{2j} \right|$
  
### iv.  Calculate Sample Resemblance
Though given enough time we could code functions for all of these measures, many of the similarity metrics are included in the vegan `vegdist()` function.
Here, we will use a few metrics to measure resemblance in each of the fish communities in the Doubs River.
However, remember from our plots above that site 8 had no observations.
We will need to remove that site from the data set.

```{r}
spe <- doubs$fish           # Assign the site-by-species matrix to 'spe'

# It is always good to check your sites
rowSums(spe)    # Notice site 8 is empty
spe <- spe[-8, ]

# Calculate Jaccard Dissimilarty 
spe.dj <- vegdist(spe, method="jaccard", binary=TRUE) # For the Jaccard mentioned above, use binary = TRUE

# Calculate Bray-Curtis Dissimilarty between Doubs River sites
spe.db <- vegdist(spe, method="bray")
```

We have now measured the resemblance of fish communities in all of the Doubs River sites. 
But, how do you visulize these data?
Well, you could print the resemblance matrix:

```{r, results='hide'}
spe.db
```

If you run this command in your console, you will see a large diagonal matrix. 
Resemblance matrices usually just show either the upper or lower triangle of values.
This is because the two triangles will have the same information.
However, if you wanted a square resemblance matrix, you could use the following commands:

```{r}
# Calculate Bray-Curtis Dissimilarty between Doubs River sites
spe.db <- vegdist(spe, method="bray", upper=TRUE, diag=TRUE)
```

J. Using the R console, view this matrix. Does this resemblance matrix show similarity or distance? How do you know?

```
    Please Provide Answer Here
```

Again, you could look at this resemblance matrix by printing the values, but that is not easy to interpret and does not easily show relations between sites.
In the next part, we will learn more elaborate ways to visualize the ecological resemblance of communities.

## D. Visualizaton

### Heatmaps
One way to visualize $\beta$-diversity is to plot the data in our resemblance matrix using a heatmap.
R has various heatmap functions.
Here we are going to use the `levelplot()` function.
In addtion, we will define our own color palette, and custom order our matrix so that our ploat looks like a resemblance matrix. 

```{r}
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
order <- rev(attr(spe.db, "Labels"))
levelplot(as.matrix(spe.db)[, order], aspect = "iso", col.regions = jet.colors, xlab="Doubs Site", ylab = "Doubs Site", main = "Bray-Curtis Distance")
```

### Cluster Analysis
Another common way to visualize $\beta$-diversity is to use a clusering.
Clustering is technique used to put objects or descriptors into groups.

There are numerous methods for clustering.
Here we are going to talk about hierarchical methods for clustering

Here we we introduce 4 clustering methods


Hierarchical Clusering Methods:
Single Linkage Clustering - groups objects based on shortest pairwise distance, tends to produce chain like groupings that are hard to interpret in tmrs of partitions but easily show gradients.; hclust( method = "single")
Complete Linkage - furtherst neighbor sorting, groups objects at the distance corresponding to the furthest distance between objects being grouped; tends to produce many small seperated groups; useful for identifying discontinuities in data
Intermediate Linkage
Unweighted Arithmetic Average Clustering (UPGMA)
Weighted Arithmetic Average Clusetering (WPGMA)
Unweighted Centroid Clustering (UPGMC)
Weighted Centroid Clustering (WPGMC)
Ward's Minimum Variance
Flexible

Each of these methods has pros and cons. 
For example, the linkage clustering methods are good at maintaining pairwise relationships between objects while the average clustering methods do not. 

Here we 

Clustering, however, is a visualization technique and does not test any underlying statistical hypotheses. 
Clustering simply reveals various features of the data to be tested elsewhere.
Therefore, the method of clustering can influence the conclusions made and should be considered prior to generating any hypotheses. 

### Hierarchical Clustering (Ward Clustering)
```{r}
spe.db <- vegdist(spe, method="bray")
spe.norm <- decostand(spe, "normalize")
spe.ch <- vegdist(spe.norm, "euc")
spe.ch.ward <- hclust(spe.ch, method="ward.D")
spe.ch.ward$height <- sqrt(spe.ch.ward$height)
plot(spe.ch.ward)

# Groups
#install.packages("gclus")
require(gclus)
spe.chwo <- reorder.hclust(spe.ch.ward, spe.ch)
plot(spe.chwo, hang=-1, xlab="4 Groups", sub="", ylab="Height", main="Chord - Ward", labels=cutree(spe.chwo, k=4))
rect.hclust(spe.chwo, k=4)
```





### Visualization using Ordination
Various techniques
| Method | Distance Preserved | Variables | 
| Princiapl component analysis (PCA) | Euclidean distance | Quantiative data, linear relationships |
| Correspondence analysis (CA) | $\chi^{2}$ distance | Non-negative, dimensionally homogeneous quantita6tive or binary data; species frequencies or presence/absence data |
| Principal coordinate analysis (PCoA), metric (multidimensional) scalling, classical scaling | Any distance measure | Quantitative, semiquantitative, qualitative, or mixed |
|Nonmetric multidimensional scalling (nMDS) |  Any distance measure | Quantitative, semiquantitative, qualitative, or mixed |

(REF: L&L , Table 9.1)

How does ordination work?
 
### NMDS
```{r}


spe.nmds <- metaMDS(spe, distance="bray")
spe.nmds
spe.nmds$stress
plot(spe.nmds, type="t", main=paste("nMDS/Bray - Stress =", round(spe.nmds$stress, 3)))
abline(h=0, lty=3)
abline(v=0, lty=3)
```

What is the nMDS stress? How is this used to judge the quality of the ordination


### Classic Multidemensional Scalling (PCoA)
```{r}
spe.bray <- vegdist(spe, method="bray")
spe.b.pcoa <- cmdscale(spe.bray, eig=TRUE)

ordiplot(scores(spe.b.pcoa)[,c(1,2)], type='t', main="PCoA with species")
abline(h=0, lty=3)
abline(v=0, lty=3)

# Add Species
spe.wa <- wascores(spe.b.pcoa$points[,1:2], spe)
text(spe.wa, rownames(spe.wa), cex=0.7, col="red")

```

```{r}
evplot <- function(ev)
{
  # Broken stick model (MacArthur 1957)
	n <- length(ev)
	bsm <- data.frame(j=seq(1:n), p=0)
	bsm$p[1] <- 1/n
	for (i in 2:n) bsm$p[i] <- bsm$p[i-1] + (1/(n + 1 - i))
	bsm$p <- 100*bsm$p/n
	# Plot eigenvalues and % of variation for each axis
	par(mfrow=c(2,1))
	barplot(ev, main="Eigenvalues", col="bisque", las=2)
	abline(h=mean(ev), col="red")
	legend("topright", "Average eigenvalue", lwd=1, col=2, bty="n")
	barplot(t(cbind(100*ev/sum(ev), bsm$p[n:1])), beside=TRUE, 
		main="% variation", col=c("bisque",2), las=2)
	legend("topright", c("% eigenvalue", "Broken stick model"), 
		pch=15, col=c("bisque",2), bty="n")
}

evplot(spe.b.pcoa$eig)


env <- doubs$env
env <- env[-8, ]
spe.pcoa.env <- envfit(spe.b.pcoa, env)
evplot(spe.b.pcoa$eig)
```


### Why not PCA?




```{r}


```


## E. Hypothesis Testing

### Multivariate Regression Trees
As mentioned above, clustering is not a hypothesis testing approach.

```{r}

# Apparently, the package mvpart is not available for R v 3.1.2
#spe.ch.mvpart <- mvpart(data.matrix(spe.norm) ~ ., env, margin = 0.08, cp = 0, xv = "min", xval = nrow(spe), xvmult = 100, which = 4)
#summary(spe.ch.mvpart)
#printcp(spe.ch.mvpart)




### Constrained Ordination

```{r}
# subset explanatory varaibles



envdas <- env[,1]
envtopo <- env[,c(2:4)]
envchem <- env[,c(5:11)]
spe.hel <- decostand(spe, method="hellinger")

spe.rda <- rda(spe.hel ~ ., envchem)
coef(spe.rda)

spechem.physio <- rda(spe.hel, envchem, envtopo)

# PermutationTest
anova.cca(spe.rda, step=1000)
```


### Variance Partitioning
```{r}
spe.part.all <- varpart(spe.hel, envchem, envtopo)


```

### Multivariate Models
Mantel Test

PERMANOVA




## Homework
Microbes in an Agricultural System

History of the system
Define hypotheses

Richness (rarefied) for each treatment (barplot, box-n-whisker plot)
Bray Curtis
PCoA
PERMANOVA
Indicator groups

BCI Data - which physical property underlies variation in Tree Composition


