---
title: "Among Site (Beta) Diversity"
author: "Z620: Quantitative Biodiversity, Indiana University"
date: "February 6, 2015"
header-includes:
   - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

## OVERVIEW
In this excercise, we move beyond the investgation of within-site, $\alpha$-diversity.
We will explore $\beta$-diversity, which is defined as the diveristy that occurs among sites. 
This requires that we examine the compositional similarity of assemblages that vary in space or time. 

After completing this exercise you will know how to:

1. formally quantify $\beta$-diversity
2. visualize $\beta$-diversity with heatmaps, cluster analysis, and ordination
3. test hypotheses about $\beta$-diversity using multivariate statistics

## 1) SETUP
### Retrieve and Set Your Working Directory

```{r, results = 'hide'}
rm(list=ls())
getwd()
setwd("~/GitHub/QuantitativeBiodiversity/Assignments/Beta")
```

### Load Packages 

We will be using the `vegan` package again; let's load it now. 

```{r, results = 'hide', message = FALSE, warning = FALSE} 
require("vegan")
```

## 2) LOADING DATA

To date, we have analyzed biodiversity data sets for freshwater zooplankton, tropical trees, and soil bacteria.
In this exercise, we introduce a new dataset containing information on stream fish assemblages from the Doubs river, which runs near the France-Switzerland boarder in the Jura Mountains.
The data set (`doubs`) includes fish abundances, environmental variables, and spatial cooridinates for 30 sites. 
The data set has previously been used to demonstrate that fish communities can be a good indicator of ecological zones in rivers and streams. 

Let's load the `ade` package, which contains the `doubs` data set. 

```{r, results = 'hide', message = FALSE, warning = FALSE} 
require("ade4")
data(doubs)
```

### Introduction to a new data structure: Lists
While working in R this semester, we have learned about vectors, matrices, and data frames. 
Here we introduce another data structure: a **list**. 
In R, a list is an object that contains a collection of other objects of similar or different types.g

### The Doubs dataset
We can use the `str()` function to describe some of the attributes of `doubs`, which is a list.
Because this dataset is somewhat complex, we can pass the "max.level = 1" arguement to minimize the output of `str()`. 
Also, you can use the the dollar sign (`$`) between the list name (`doubs`) and objects within the list (e.g., `env`) to explore the data set. 
Last, recall that you can use `help()` to learn more about a data set that is contained in a package. 

```{r, results='hide'}
str(doubs, max.level = 1)
```

***Question 1***:  Describe some of the attributes of the `Doubs` dataset. 

a.  How many objects are in the `Doubs` data set?
b.  What types of data structures are contained in the `Doubs` dataset?
c.  What are the units of nitrate ("nit") in the stream water?
d.  How many fish species are there in the `Doubs` dataset?

> ***Answer 1a***:  
> ***Answer 1b***:  
> ***Answer 1c***:  
> ***Answer 1d***:  

### Visualizing the Doubs dataset
There is a wealth of information in the `Doubs` dataset that can be used to address various issues related to $\beta$-diversity.
For example, we might use the environmental or spatial data to develop or test a hypothesis.
Below we have generated two plots of the `Doubs` fish data. 
The first plot shows fish richness at each site in the stream.
The second plot shows the abundance of a particular fish species at each site in the stream.

```{r, fig.width=8, fig.height=3.75, echo=FALSE}
# Define Plot Parameters
par(mfrow = c(1,2), mar = c(4, 4, 3, 4) + 0.1, xpd = TRUE)

# Stream Fish
spa.S <- specnumber(doubs$fish)               
spa.S.color <- rev(terrain.colors(31))    # Define Richness Color Pallette
spa.N.color <- rev(terrain.colors(7))     # Define Abundance Color Pallette

# Stream Fish Richness
plot(doubs$xy, asp = 1, type = 'l', col = "light blue", lwd = 10, las = 1, cex.axis = 0.75,
     xlim = c(0,280), ylim = c(0,280), main = "Fish Richneses (S)", 
     xlab = "X-Coordinate (km)", ylab = "Y-Coordinate (km)")
points(doubs$xy, pch = 22, cex=2, bg = spa.S.color[spa.S + 1])
text(doubs$xy, as.character(spa.S), cex = 0.5, col="red")
text(150, 0, "Upstream", cex = 1, col = "red")
text(48, 114, "Downstream", cex = 1, col = "red")
legend("topright", inset=c(-0.25, 0), pch = 22, pt.cex = 2, bty = 'n',
       title = "S", legend = seq(0, 30, 10), pt.bg = spa.S.color[seq(1, 31, 10)])    

# Brown Trout Abundance
plot(doubs$xy, asp = 1, type = 'l', col = "light blue", lwd = 10, las = 1, cex.axis = 0.75, 
     xlim = c(0, 280), ylim = c(0, 280),main = "Brown Trout Abundance (N)", 
     xlab = "X-Coordinate (km)", ylab = "Y-Coordinate (km)")
points(doubs$xy, pch = 22, cex=2, bg = spa.N.color[doubs$fish$Satr + 1])
text(doubs$xy, as.character(doubs$fish$Satr), cex = 0.5, col="red")
text(150, 0, "Upstream", cex=1, col="red")
text(48, 114, "Downstream", cex=1, col="red")
legend("topright", inset=c(-0.25, 0), pch = 22, pt.cex = 2, bty = 'n',
       title = "N", legend = seq(0, 6, 2), pt.bg = spa.N.color[seq(1, 7, 2)])
```

***Question 2***: Answer the following questions based on the spatial patterns of richness (i.e., $\alpha$-diversity) and Brown Trout (*Salmo trutta*) abundance in the Doubs River. 

a.  How does fish richness vary along the Doubs River?
b.  How does Brown Trout (*Salmo trutta*) abundance vary along the Doubs River?
c.  What do these patterns say about the limitations of using richness when examining patterns of biodiversity?

> ***Answer 2a***:  
> ***Answer 2b***:  
> ***Answer 2c***:  

## 3) QUANTIFYING BETA-DIVERSITY BETWEEN TWO SAMPLES

There are various ways to quantify $\beta$-diversity. 
Perhaps one of the simplest metrics is **Whittaker's** $\pmb\beta$-**Diversity**, which was developed by Robert Whittaker (1960). 
This classic index is useful for comparing $\beta$-diversity between two samples. 
The equation for Whittaker's $\beta$-Diversity is as follows:
$\beta_{W} = \frac{S}{\bar{\alpha}} - 1$ 
where *S* = the total number of species recorded across sites (i.e., $\gamma$-diversity) and $\bar{\alpha}$ which is the mean richness (i.e., $\alpha$ diversity) among sites.
Subtracting 1 scales $\beta_{w}$ from 0 (minimum $\beta$-diversity) to 1 (maximum $\beta$-diversity).

We can write this as a function in R:

```{r}
beta.w <- function(site1 = "", site2 = ""){
  site1 = subset(site1, select = site1 > 0)               # Removes absences
  site2 = subset(site2, select = site2 > 0)               # Removes absences
  gamma = union(colnames(site1), colnames(site2))         # Gamma species pool
  s     = length(gamma)                                   # Gamma richness
  a.bar = mean(c(specnumber(site1), specnumber(site2)))   # Avg sample richness
  b.w   = round(s/a.bar - 1, 3)
  return(b.w)
}
```

***Question 3***: Using the `beta.w` function above, answer the following questions:
a.  What is the $\beta$-diversity for fish assemblages sampled from site 1 and site 2 of the `doubs` data set? 
b.  Based on the formula for $\beta_{w}$, what does this value represent?

> ***Answer 3a***:  
> ***Answer 3b***: 

## 4) QUANTIFYING BETA-DIVERSITY FOR TWO OR MORE SAMPLES

Often, we often want to compare the diversity of more than just a pair of samples. 
In this section we will estimate $\beta$-diversity for multiple samples. 
During this process, you will learn how to generate similarity and dissimilarity matrices for different data sets that will be needed for visualizing and quantifying $\beta$-diversity. 

### Resemblance Matrix
In order to quantify $\beta$-diversity for more than two samples, we need to introduce our second primary ecological data structure: the **Resemblance Matrix**. 
In the context of biodiversity, a resemblance matrix is a data structure that calculates the pairwise **similarity** or **dissimiliarity** for all samples in a site-by-species matrix. 
The resemblance matrix can be generated from a site-by-species matrix containing incidence (presence-absence) data or abundance data. 
In the sections below, we describe some of the common similarity and dissimilarity metrics used for constructing a resemblance matrix.
Throughout this handout, we will use common notations in accordance with Legendre & Legendre (2012), which can be electronically accessed via the IU library (see the course syllabus [http://goo.gl/y4oK7c]). 

### A.  Incidence-Based Measures of Similarity and Dissimilarity
When you are working with presence-absence data, you can you the following metrics for generating a similarity or dissimilarity matrix. 

\begin{center}
\hyphenpenalty 10000
\exhyphenpenalty 10000
\begin{tabular}{ m{2.5cm} m{5.5cm} m{6.5cm} }
  \textbf{Index} & \textbf{Equation} & \textbf{Properties} \\
  \hline \hline \\ [-1.5ex]
  Jaccard & 
  $S_7 = \frac{a}{a+b+c}$ & 
  Compares the number of shared species to the number of species in the combined assemblages  (global view) \\
  \\ [-1.5ex]
  Sørensen & 
  $S_8 = \frac{2a}{(2a+b+c)}$ & 
  Compares the number of shared species to the mean number of species in a single assemblage (local view) \\
  \\ [-1.5ex]
  \hline
  \end{tabular}
  \end{center}

In the above table, *a* = the number of shared speces, *b* = the number of unique species in the first assemblage, and *c* = the number of unique species in the second assemblage.

***Question 4***: What are the differences between Jaccard and Sørensen metrics? When might you use one instead of the other? In what situations would these measures of $\beta$ diversity fail?

> ***Answer 4a***:  
> ***Answer 4b***:  
> ***Answer 4c***:  

*Notes on incidence-based similarity*: Jacard and Sørensen are perhaps the two most commonly used incidence-based measures of similarity. 
Others include Ochiai, Kulczynski-Cody, and Lennon, which can be found in Table 6.1 of Magurran & McGill (2011). 
The differences in these measures include how means are calculated (Sørensen = harmonic mean, Ochiai = geometric mean, and Kulczynski-Cody = arithmetic mean), and how unique species are dealt with if only one sample has unique species (Lennon). 

Also, it is important to note that these equations calculate similarity, but can (and in many cases should) be converted to dissimilarity (*D*). 
In `vegan`, disimilarities (*D*) are usually returned from functions instead of similarities (*S*).
The conversion between similarity and dissimilarity is calculated as `D = 1 - S`.

### B.  Abundance-Based Measures of Similarity and Dissimilarity
When you are working with abundance data, you can you the following metrics for generating a similarity or dissimilarity matrix. 

\begin{center}
\hyphenpenalty 10000
\exhyphenpenalty 10000
\begin{tabular}{ m{2.5cm} m{5.5cm} m{6.5cm} }
  \textbf{Index} & \textbf{Equation} & \textbf{Properties} \\ 
  \hline \hline \\ [-1.5ex]
  \raggedright Bray-Curtis Dissimilarity &
  $D_{14} = \frac{\sum\limits_{j=1}^{p} \left|{y_{1j} - y_{2j}} \right|}{\sum\limits_{j = 1}^{p}\left(y_{1j} + y_{2j}\right)}$  &
  A quantitative version of the Sørensen index. Commonly used measure of similarity. Also known as the \emph{percentage difference}. \\
  \\ [-1.5ex]
  \raggedright Morisita-Horn &
  $S_{MH} = \frac{2 \sum\limits_{j=1}^{p} y_{1j} \cdot y_{2j}}{\left(\sum\limits_{j=1}^{p}y_{1j}^{2} + \sum\limits_{j=1}^{p} y_{2j}^{2}\right)}$ &
  A measure of \emph{compositional overlap}. Uses squared differences in relative abundance and thus is most influenced by more abundant species. Resistant to undersampling. \\
  \\ [-1.5ex]
  \hline
  \end{tabular}
  \end{center}

In the above table $y_{1j}$ is the abundance of each species (1:p) in site 1 and $y_{2j}$ in site 2. 

As with incidence-based measures, there are many other options for calculating similarity or dissimilarity between communities, which include Mean Character Difference, Canberra, Coefficient of Divergence, and Grower. 

### C. A Cautionary Note on Other Measures of Distance
Some distance measures have been developed for and are widely used to compare quantitative discriptors.
However, in general, they should not be used for abundance-based data.
This is because they lead to the *Species Abundance Paradox*: the distance between two sites that have no species in common is smaller than the distance between sites with shared species.
Examples of these types of measure include Euclidean Distance and Manhattan Distance:

***Euclidean Distance***: 
$D_{1} = \sqrt{\sum\limits_{j =1}^{p} \left( y_{1j} - y_{2j} \right)^{2}}$

***Manhattan Distance***: 
$D_{7} = \sum\limits_{j = 1}^{p} \left| y_{ij} - y_{2j} \right|$

It should be noted that methods exist to transform species abundance data prior to implementing metrics like Euclidean Distance and Manhattan Distance (e.g., Chord transformation and Chi-Square transformation).
It is recommended that you read more about these distance metrics if you are interested in implementing them to address your research questions.

### D.  Constructing the Resemblance Matrix

Conveniently, `vegan` includes many of the similarity metrics used to construct a resemblance matrix.  
These metrics can be calcualted using the `vegdist()` function.
Let's use `vegdist` to create a resemblance matrix for the fish assemblages in the Doubs River (`doubs`). 
However, we'll need to remove site 8 from `doubs` because for some reason it has no observations. 

```{r}
fish <- doubs$fish 
fish <- fish[-8, ] # Remove site 8 from data

# Calculate Jaccard 
fish.dj <- vegdist(fish, method="jaccard", binary=TRUE)

# Calculate Bray-Curtis 
fish.db <- vegdist(fish, method="bray")
```

Now that we've created a resemblance matrix, it would be nice to visualize the fish assemblages of the Doubs River. 
As a start, we can print the Bray-Curtis-based resemblance matrix in the console:

```{r, results='hide'}
fish.db
```

From this, you will see a large diagonal matrix. 
Typically, resemblance matrices just show the upper or lower triangle of values.
This is because the two triangles have the same information.
However, you can generate a square resemblance matrix with the following command:

```{r}
fish.db <- vegdist(fish, method="bray", upper=TRUE, diag=TRUE)
```

***Question 5***: Does the resemblance matrix (`fish.db`) represent similarity or dissimilarity? How do you know?

> ***Answer 5***: 

## 5) VISUALIZING BETA-DIVERSITY

### A.  Heatmaps
One way to visualize $\beta$-diversity is to plot the data in our resemblance matrix using a **heatmap**.
Heatmaps are a two-dimensional, color representation of a data matrix. 
R has various heatmap functions.
Here we are going to use the `levelplot()` function in the `lattice` package of R.
This function will allow us to make a basic heatmap of our resemblance matrix.
However, first there are a few things we need to do:
1. We need to define a color palette.
R include many predefined color palettes; however, we are going to make our own color palette.
2. We need to make sure that our resemblance matrix is plotted correctly. 
In particular, we need specify the order in which we want our sites plotted.

```{r}
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", 
                                 "#7FFF7F", "yellow", "#FF7F00", "red", 
                                 "#7F0000"))
order <- rev(attr(fish.db, "Labels"))  # defines order of sites for plotting
levelplot(as.matrix(fish.db)[, order], aspect = "iso", col.regions = jet.colors, 
          xlab="Doubs Site", ylab = "Doubs Site", scales=list(cex=0.5), 
          main = "Bray-Curtis Distance")
```

### B.  Cluster Analysis
Another common way to visualize $\beta$-diversity is through cluster analysis.
Clustering is mostly an exploratory technique that places objects in groups based on their similarity to one another.
In this exercise, we will use hierarchical clustering, specifically Ward's Clustering. 
Ward's Clustering (i.e., Ward's minimum variance method) is a clustering technique based  on the linear model criterion of least squares.
The method minimizes within-cluster sums of squared distances between sites.
However, there are numerous methods for clustering (e.g., Single Linkage, UPGMA, UPGMC), and the choice of clustering method can influence your conclusions.  
See chapter 8 of Legendre and Legendre (2012) for more information on the various clustering methods that can be used. 

```{r}  
fish.ward <- hclust(fish.db, method="ward.D2")
plot(fish.ward, xlab = "Doubs River Fish", 
     ylab = "Squared Bray-Curtis Distance",
     sub = "Ward's Clustering")
```

Another clustering visualization tool that can be used for exploratory purpsoses is`heatmap.2()` function from the `gplots` package.
This tool will generate a clustering diagram that incorporates fish abundance at each site.

```{r, message = FALSE, warning = FALSE}
require(gplots)
heatmap.2(as.matrix(fish), distfun = function(x) vegdist(x, method = "bray"),
          hclustfun = function(x) hclust(x, method = "ward.D2"), 
          col = jet.colors(100), trace = "none", density.info="none")
```

***Question 6***: Based on this clustering analysis and the introdutory plots that we generated after loading the data, what hypotheses could be addressed with the `doubs` data set?

> ***Answer 6***: 


### C.  Ordination
Ordination is a statistical technique that is used for visualizing objects (e.g., sites) when there are multiple observations (e.g., species within sites). 
The aim of ordination is to represent multiple variables (e.g., sites) in a reduced number of orthogonal (linearly independentand uncorrelated) axes. 
Axes are constructed and order in such a way to capture the main trends in the data, in decreasing order.
Thus, when objects are plotted (usually in two or three dimensions or "axes"), ordination can be useful for determining similarity among objects. 
For example, sites that are closer in ordination space have species assemblages that are more similar to one another than sites that are further apart in ordination space.  
There are various orditnation techniques that can be applied to multivariate biodiversity data.
Common methods include: Principal Component Analysis, Correspondence Analysis, Principal Coordinate Analysis, and Nonmetric Multidemensional Scalling.
When choosing an ordination technique, carefull consideration should be given based on the data type (continuous vs. categorical), model assumptions, and the underlying mathematical procedures that are invovled.

In this exercise, we focus on one commonly used ordination technique: **Principal Coordinates Analysis (PCoA)**, which is sometimes referred to as metric multidimensional scalling. 
PCoA is a robust ordination technique that can be used on any distance matrix
PCoA starts with creating a dissimilarity (i.e., resemblance) matrix, $\pmb{D}$, from a site-by-species matrix. 
Next, $\pmb{D}$ is transformed as follows: $\pmb{A} = - \frac{1}{\bar{2}} \pmb{D}^2_{ij}$ where ${ij}$ refer to the elments in $\pmb{D}$.
This transformation is used to preserve distances in $\pmb{D}$.
Next, $\pmb{A}$ is centered to reposition the multidimensional data.
The demensionality of $\pmb{A}$ is then reduced by determining each eigenvector, $\pmb{u}_i$, and eigenvalue, $\pmb{\lambda}_i$, which solve the following equation: $\pmb{A u}_i = \pmb{\lambda}_i \pmb{u}_i$. 
Finally, each eigenvector, $\pmb{u}_i$, is scaled to length $\sqrt{\pmb{\lambda}_i}$ to optain the principal coordinates.
The eigenvalues are ordered from largest to smallest.

A nice feature of PCoA is that it can accept resemblance matrices generated with various measures of dissimilarity. 
This flexibilty can be important for emphasizing or deemphasizing certain attributes of a data set (e.g., rare vs. commmon species).
When one uses a Euclidean distance matrix with PCoA, the results are identical to that of Principal Components Analysis (PCA).

### I'm not sure what the above sentences are for. Seem sketchy

To conduct a PCoA, we will use the `cmdscale` function from the `stats` package in R, which performs PCoA (AKA "classical metric multidimensional scaling").
The input for this function is our resemblance matrix (Bray-Curtis distances for the Doubs dataset).
In addition, we are going to set *k* = 3 (number of demensions we want to calculate) and *eig* = TRUE (save the eigenvalues).

```{r}
fish.pcoa <- cmdscale(fish.db, eig = TRUE, k = 3) 
```

The `cmdscale` function produces a list of outputs.
The first item *points* includes the coordinates for each site in each reduced demension.
The second item *eig* includes the eigenvalues for our analysis.
The last three items are other options in the analysis, but we will not use them here.

First, we want to explore the eigenvalues.
The eigenvalues are the scaling factors that allowed us to reduce the dimensionality of our data. 
We might start by looking at these eigenvalues to make sure that we are interpreting our analysis correctly.
For our ordination to be useful, we need to know that we captured a sufficient amount of information about the differences in our sites by looking at just a few of the ordination axes. 
One way we can do this is by making sure that the first few axes capture a greater than expected amount of possible variation.
There are two ways we can make this judgement. 
First, we might compare these initial eigenvalues to the average eigenvalues and make sure that they are larger.
Second, we might compare these initial eigenvalues to the expectation of the *broken-stick model*. 

Here, we will qualitatively make this comparision by plotting each eigenvalues and using these two assessment techniques.

```{r}
# Define Plot Parameters
par(mar = c(5, 5, 2, 2) + 0.1)
plot(fish.pcoa$eig, xlab = "PCoA Axis", ylab = "Eigenvalue", 
     las = 1, cex.lab = 1.5, pch = 16)
abline(h = mean(fish.pcoa$eig), lty = 2, lwd = 2, col = "blue")
b.stick <- bstick(29, sum(fish.pcoa$eig))
lines(1:29, b.stick, type = "l", lty = 4, lwd = 2, col = "red")
legend("topright", legend = c("Avg Eig", "Broken-Stick"), 
       lty = c(2, 4), bty= "n", col = c("blue", "red"))
```

By qualitative assessment, we can see that the first three axes of our PCoA ordination have higher eigenvalues than both the mean eigenvalue and the expectation of the Broken-Stick model. 
Based on this, we can be comfortable using these as a representation of our data.

However, it is also useful to know how much to the total variation in the data each axis captures. 
Because of the way eigenvalues are calculated we can derive this value by dividing each eigenvalues by the total of all eigenvalues.

```{r}
explainvar1 <- round(fish.pcoa$eig[1] / sum(fish.pcoa$eig), 3) * 100
explainvar2 <- round(fish.pcoa$eig[2] / sum(fish.pcoa$eig), 3) * 100
explainvar3 <- round(fish.pcoa$eig[3] / sum(fish.pcoa$eig), 3) * 100
```


***Question 7***: How much of the variation in fish community composition can be assessed by just looking at the first PCoA Axis? What is the cummulative variation that can be explained by using the first two axes?

> ***Answer 7a***:
> ***Answer 7b***:


Now that we have have used PCoA and know that the first few axes are sufficient at explaining a substantial amount of variation in the data, we can use the coordinates provides by PCoA to plot each site on an x-y scatterplot. 
 
 
```{r pcoalayer1, eval = TRUE}
# Define Plot Parameters
par(mar = c(5, 5, 2, 2) + 0.1)

# Initiate Plot
plot(fish.pcoa$points[ ,1], fish.pcoa$points[ ,2],
     xlab=paste("PCoA 1 (", explainvar1, "%)", sep=""),
     ylab=paste("PCoA 2 (", explainvar2, "%)", sep=""),
     pch=16, cex=2.0, type="n", cex.lab=1.5, cex.axis=1.2, axes=FALSE)

# Add Axes
axis(side = 1, labels=T, lwd.ticks=2, cex.axis=1.2, las = 1)
axis(side = 2, labels=T, lwd.ticks=2, cex.axis=1.2, las = 1)
abline(h = 0, lty = 3)
abline(v = 0, lty = 3)
box(lwd=2)

# Add Points & Labels
points(fish.pcoa$points[ ,1], fish.pcoa$points[ ,2],
       pch=19, cex=3, bg="gray", col="gray")
text(fish.pcoa$points[ ,1], fish.pcoa$points[ ,2], 
     labels = row.names(fish.pcoa$points))
```
 

***Question 8***: As you will recall, these fish communities were sampled along the Doubs River in the Jara Mountains (France-Switzerland boarder). In addition, you know that these sites are ordered in space with site 1 being the most upstream and site 30 being the most downstream (see plot in section 2). Given this, what hypotheses could you make about these fish communities? (Reminder: the original goals of this study included using fish communities as indicators of stream health). 

> ***Answer 8***:


One useful feature of ordinations is the ability to plot expainatory vectors in your reduced ordination space. 
For example, we might be interested in how individual fish species contribute to the patterns observedin our PCoA. 
In the PCoA plot that you just created, we are looking at the relationship of samples in species space. 
Differences in species abundances are contributing the separation of samples along each PCoA axis. 
We can gain some insight into "who" is responsible for this separation by examining the correlation between the site scores and the species relative abundances. 
We will obtain this information using the `add.spec.scores` function in the R `BiodiversityR` package, which we will now load.
First, we will use this function to calculate coordinates of each species on the PCoA.
These coordinates reflect how the species contribute to the patterns seen in the ordination.
Then we will use the same function to determine the correlation of species for each axis.
We can use some cut-off criteria to pull out the important species for each axis.
Finally, we will use another function, `envfit()` from the vegan pacakge, to conduct a permutation test on these correlations.

```{r pcoalayer2, echo=-1}
<<pcoalayer1>>
require("BiodiversityR")

# Calculating Relative Abundance
fishREL <- fish
  for(i in 1:nrow(fish)){
    fishREL[i, ] = fish[i, ]/sum(fish[i, ])
    } 

# Calculate and Add Species Scores
fish.pcoa <- add.spec.scores(fish.pcoa,fishREL,method="pcoa.scores")
text(fish.pcoa$cproj[ ,1], fish.pcoa$cproj[ ,2], 
     labels = row.names(fish.pcoa$cproj), col = "black")

# Other Measures of Correlation
spe.corr <- add.spec.scores(fish.pcoa, fishREL, method = "cor.scores")$cproj
# spe.corr <- spe.corr[order(spe.corr[, 1],decreasing=TRUE),] # sorts based on r of PCoA axis 1
corrcut <- 0.7                                              # define cutoff
imp.spp <- spe.corr[abs(spe.corr[, 1]) >= corrcut | abs(spe.corr[, 2]) >= corrcut, ]

fit <- envfit(fish.pcoa, fishREL, perm = 999)
```

***Question 9***: Using the correlations above, can you generate any hypotheses about which fish species are potential indicators of river quality? Discuss any differences in the three methods used.

> ***Answer 9a***: 
> ***Answer 9b***

## 6) HYPOTHESIS TESTING

Some of the visualization tools that we just learned about are powerful for exploring data sets and generating hypotheses, but  can fall short of providing robust tests of *a priori* hypotheses and predictions. 
Here, we wil introduce a few techniques that are appropriate for testing hypotheses that you might have when using multivariate data and are interested in questions related to $\beta$-diversity. 

### A.  Multivariate procedures for categorical designs

PERMANOVA stands for permutational multivariate analysis of variance. 
It is a multivariate analog to univariate ANOVA and has less restrictions than parametric multivariate analysis of variance (MANOVA). 
As the name suggests, it evaluates differences according to your specified model by randomly permuting the data.
PERMANOVA can easily handle simple designs, but also accomodates nested and higher-order studies. 
It can handle missing observations and supplies output such as F ratios, pseudo P-values, and R^{2} values.
We will implement PERMANOVA with the `adonis` function in the `vegan` package. 

To run `adonis`, you need to import a "factors" table, which specifies your treatments and replicates. 
There are actually two treatments associated with the `soilbac` data set. 
The first is the land-use factor, which has already been introduced. 
The other factor is watering treatment. 
Half the soil samples were characterized when they were very dry, and the other half were characterized three days after being watered.
So, in the end, we have a two-by-two full factorial design (with the exception of one missing sample from the DF land-use treatment)

Let's import our factors table associated with `soilbac`. 

```{r}
factors <- read.table("./data/soil.factors.txt" , sep = "\t", header=TRUE) 
```

Now, we can run `adonis` on the `soilbac` site-by-species matrix, but we also need to specify the model, the number of permutations, and the dissimilarity metric that we want to use to create a resemblance matrix. 

```{r}
soil.adonis <-adonis(soilbac ~ land + time + land*time, factors, permutations = 999, method = "bray") 
```

***Question 8***: Using the output of the PERMANOVA model, interpret the resuls of the experiment that generated the `soilbac` data set. 

> ***Answer 8***: 


### B.  Mutivariate procedures for continuous designs

### i.  Mantel test
A **Mantel test** is essentially a multivariate correlation analysis. 
It produces an *r* value that is analagous to the Pearson's correlation coefficient. 
The p-value from the Mantel test is derived from the deviation of observed correlation to that of correlations derived from randomizations of the two matrices. 

In the following section, we will peform a Mantel test using the `mantel` function in `vegan`. 
This requires that we first create a distance matrix for each of our raw matrices. 
After creating the distance matrices, we will test the hypotheses that 1) fish assemblages are correlated with stream environmental variables, and 2) fish assemblages are correlated with geographic location.

```{r}
fish.dist <- vegdist(doubs$fish[-8, ], method = "bray")
env.dist <- vegdist(scale(doubs$env[-8,]),method = "euclid")
geo.dist <- vegdist(doubs$xy[-8,], method = "euclid")
mantel(fish.dist,env.dist)
mantel(fish.dist,geo.dist)
```

The results from our Mantel tests suggest that fish diversity is correlated with stream environmental conditions *and* geographic location. 
We can try to tease this relationship apart by conducting a **partial Mantel test**. 
In this type of an analysis, we can look for a correlation between two matrices while "controlling" for a third matix. 
For our example, we will look for correlations between fish assemblage and the stream environment, while holding geography constant. 

```{r}
mantel.partial(fish.dist, env.dist, geo.dist, method = "pearson", permutations = 999)
```

***Question 9***: What conclusions can you draw about the effects of geography and environmental conditions on the $\beta$-diversity of fish in the Doubs River based on the results of the Mantel tests above?

> ***Answer 9***: 

## 7) HOMEWORK

1.  We are going to revsit the soil bacteria data set from the $\alpha$-diversity exercise. 
You may recall that 16S rRNA sequences were generated from replicate sites from four different land-use treatments (T1 = agriculture, T7 = grassland, DF = deciduous forest, and CF = coniferous forest). 
On top of this, we characterized bacteria from the above soils under dry vs. wet condtions. 
Thus, we have a 2 x 2 full factorial design (with the exception of a missing sample from the DF land-use treatment). 
More background on this study can be found in Aanderud et al. 2015 (http://goo.gl/TRgISq)

Two files are available to you in the "~/Assignments/Beta/data"" directory:

a.  Site-by-species matrix ("soilbacfull.txt")
b.  Factors file describing the treatments ("soil.factors.txt")

Use a combination of visualization and hypothesis-testing techniques described above, interpret the results from the exepriment in a $\beta$-diversity framework. 

2.  Use Knitr to create a pdf of your completed alpha_exercise.Rmd document, push it to GitHub, and create a pull request.
The due date for this assignment will be announced in class and/or canvas.













***Not sure what we want to do with the following section  -- JTL***
### Constrained Ordination

```{r}
# subset explanatory varaibles


# 
# envdas <- env[,1]
# envtopo <- env[,c(2:4)]
# envchem <- env[,c(5:11)]
# spe.hel <- decostand(spe, method="hellinger")
# 
# spe.rda <- rda(spe.hel ~ ., envchem)
# coef(spe.rda)
# 
# spechem.physio <- rda(spe.hel, envchem, envtopo)
# 
# # PermutationTest
# anova.cca(spe.rda, step=1000)
```

### Multivariate Models
Mantel Test --> could be useful

PERMANOVA --> on soilbac data

CCA --> could be done on Doubs or introduce BCI/BCIsoils







