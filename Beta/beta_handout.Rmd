---
title: "Among Site (Beta) Diversity"
author: "Z620: Quantitative Biodiversity, Indiana University"
date: "February 6, 2015"
header-includes:
   - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

## OVERVIEW
In this excercise, we move beyond the investgation of within-site, $\alpha$-diversity.
We will explore $\beta$-diversity, which is defined as the diveristy that occurs among sites. 
This requires that we examine the compositional similarity of assemblages that vary in space or time. 

After completing this exercise you will know how to:

1. formally quantify $\beta$-diversity
2. visualize $\beta$-diversity with heatmaps, cluster analysis, and ordination
3. test hypotheses about $\beta$-diversity using multivariate statistics

## 1) SETUP
### Retrieve and Set Your Working Directory

```{r, results = 'hide'}
rm(list=ls())
getwd()
setwd("~/GitHub/QuantitativeBiodiversity/Assignments/Beta")
```

### Load Packages 

We will be using the `vegan` package again; let's load it now. 

```{r, results = 'hide', message = FALSE, warning = FALSE} 
require("vegan")
```

## 2) LOADING DATA

To date, we have analyzed biodiversity data sets for freshwater zooplankton, tropical trees, and soil bacteria.
In this exercise, we introduce a new dataset containing information on stream fish assemblages from the Doubs river, which runs near the France-Switzerland boarder in the Jura Mountains.
The data set (`doubs`) includes fish abundances, environmental variables, and spatial cooridinates for 30 sites. 
The data set has previously been used to demonstrate that fish communities can be a good indicator of ecological zones in rivers and streams. 

Let's load the `ade` package, which contains the `doubs` data set. 

```{r}
require(ade4)
data(doubs)
```

### Introduction to a new data structure: Lists
While working in R this semester, we have learned about vectors, matrices, and data frames. 
Here we introduce another data structure: a **list**. 
In R, a list is an object that contains a collection of other objects of similar or different types.

We can use the `str()` function to describe some of the attributes of `doubs`, which is a list.
Because this dataset is somewhat complex, we can pass the "max.level = 1" arguement to minimize the output of `str()`. 
Also, you can use the the dollar sign (`$`) between the list name (`doubs`) and objects within the list (e.g., `env`) to explore the data set. 
Last, recall that you can use `help()` to learn more about a data set that is contained in a package. 

```{r, results='hide'}
str(doubs, max.level = 1)
```

***Question 1***:  Describe some of the attributes of the `doubs` dataset. 

a.  How many objects are in the list `doubs`?
b.  What types of data structures are contained in the `doubs` list?
c.  What are the units of nitrate ("nit") in the stream water?
d.  How many fish species are there in the `doubs` list?

> ***Answer 1a***:  
> ***Answer 1b***:  
> ***Answer 1c***:  
> ***Answer 1d***:  

There is a wealth of information in the `doubs` dataset that can be used to address various issues related to $\beta$-diversity.
For example, we might use the environmental or spatial data to develop or test a hypothesis.
Below we have generated two plots of the doubs fish data. 
The first plot shows fish richness at each site in the stream.
The second plot shows the abundance of a particular fish species at each site in the stream.

```{r, fig.width=8, fig.height=3.75, echo=FALSE}
# Define Plot Parameters
par(mfrow = c(1,2), mar = c(4, 4, 3, 4) + 0.1, xpd = TRUE)

# Stream Fish
spa.S <- specnumber(doubs$fish)               
spa.S.color <- rev(terrain.colors(31))    # Define Richness Color Pallette
spa.N.color <- rev(terrain.colors(7))     # Define Abundance Color Pallette

# Stream Fish Richness
plot(doubs$xy, asp = 1, type = 'l', col = "light blue", lwd = 10, las = 1, 
     xlim = c(0,280), ylim = c(0,280), main = "Fish Richneses (S)", 
     xlab = "X-Coordinate (km)", ylab = "Y-Coordinate (km)")
points(doubs$xy, pch = 22, cex=2, bg = spa.S.color[spa.S + 1])
text(doubs$xy, as.character(spa.S), cex = 0.5, col="red")
text(150, 0, "Upstream", cex = 1, col = "red")
text(48, 114, "Downstream", cex = 1, col = "red")
legend("topright", inset=c(-0.25, 0), pch = 22, pt.cex = 2, bty = 'n',
       title = "S", legend = seq(0, 30, 10), pt.bg = spa.S.color[seq(1, 31, 10)])    

# Brown Trout Abundance
plot(doubs$xy, asp = 1, type = 'l', col = "light blue", lwd = 10, las = 1, cex.axis = 0.75, 
     xlim = c(0, 280), ylim = c(0, 280),main = "Brown Trout Abundance (N)", 
     xlab = "X-Coordinate (km)", ylab = "Y-Coordinate (km)")
points(doubs$xy, pch = 22, cex=2, bg = spa.N.color[doubs$fish$Satr + 1])
text(doubs$xy, as.character(doubs$fish$Satr), cex = 0.5, col="red")
text(150, 0, "Upstream", cex=1, col="red")
text(48, 114, "Downstream", cex=1, col="red")
legend("topright", inset=c(-0.25, 0), pch = 22, pt.cex = 2, bty = 'n',
       title = "N", legend = seq(0, 6, 2), pt.bg = spa.N.color[seq(1, 7, 2)])
```

***Question 2***: Answer the following questions based on the spatial patterns of richness (i.e., $\alpha$-diversity) and Brown Trout (*Salmo trutta*) abundance in the Doubs River. 

a.  How does fish richness vary along the Doubs River?
b.  How does Brown Trout (*Salmo trutta*) abundance vary along the Doubs River?
c.  What does this say about the limitations of richness when trying to understand patterns of biodiversity?

> ***Answer 2a***:  
> ***Answer 2b***:  
> ***Answer 2c***:  

## 3) QUANTIFYING BETA-DIVERSITY BETWEEN TWO SAMPLES
There are various ways to quantify $\beta$-diversity. 
Perhaps one of the simplest metrics is $\pmb\beta$-**Diversity**, which was developed by Robert Whittaker (1960). 
This classic index is useful for comparing $\beta$-diversity between two samples. 
The equation for Whittaker's $\beta$ is as follows:
$\beta_{W} = \frac{S}{\bar{\alpha}} - 1$ 
where *S* = the total number of species recorded in a system (i.e., $\gamma$-diversity) and $\bar{\alpha}$ which is the mean sample richness (i.e., $\alpha$ diversity).
Subtracting 1 scales $\beta_{w}$ from 0 (minimum $\beta$-diversity) to 1 (maximum $\beta$-diversity).

We can write this as a function in R:

```{r}
beta.w <- function(site1 = "", site2 = ""){
  site1 = subset(site1, select = site1 > 0)               # Removes absences
  site2 = subset(site2, select = site2 > 0)               # Removes absences
  gamma = union(colnames(site1), colnames(site2))         # Gamma species pool
  s     = length(gamma)                                   # Gamma richness
  a.bar = mean(c(specnumber(site1), specnumber(site2)))   # Avg sample richness
  b.w   = round(s/a.bar - 1, 3)
  return(b.w)
}

fish <- doubs$fish
b <- beta.w(fish[1,], fish[2, ])
```

***Question 3***: Using the `beta.w` function above, answer the following questions
a.  What is the $\beta$-diversity for fish sampled from site 1 and site 2 of the `doubs` data set? 
b.  Based on the formula for $\beta_{w}$, what does this value represent?

> ***Answer 3a***: 
> ***Answer 3b***: 

## 4) QUANTIFYING BETA-DIVERSITY FOR TWO OR MORE SAMPLES

Often, we often want to compare the diversity of more than just a pair of samples. 
In this section we will estimate $\beta$-diversity for multiple samples. 
During this process, you will learn how to generate similarity and dissimilarity matrices for different data sets that will be needed for visualizing and quantifying $\beta$-diversity. 

### Resemblance Matrix
In order to quantify $\beta$-diversity for more than two samples, we need to introduce our second primary ecological data structure: the **Resemblance Matrix**. 
In the context of biodiversity, a resemblance matrix is a data structure that calculates the pairwise **similarity** or **dissimiliarity** for all samples in a site-by-species matrix. 
The resemblance matrix can be generated from a site-by-species matrix containing incidence (presence-absence) data or abundance data. 
In the sections below, we describe some of the common similarity and dissimilarity metrics used for constructing a resemblance matrix.
Throughout this handout, we will use common notations in accordance with Legendre & Legendre (2012), which is a recommended book that can be electronically accessed via the IU library (see the course syllabus [http://goo.gl/y4oK7c]). 

### A.  Incidence-Based Measures of Similarity and Dissimilarity

\begin{center}
\begin{tabular}{ m{2.5cm} m{5.5cm} m{6.5cm} }
  \textbf{Index} & \textbf{Equation} & \textbf{Properties} \\
  \hline \hline \\ [-1.5ex]
  Jaccard & 
  $S_7 = \frac{a}{a+b+c}$ & 
  Compares the number of shared species to the number of species in the combined assemblages  (global view ) \\
  \\ [-1.5ex]
  Sørensen & 
  $S_8 = \frac{2a}{(2a+b+c)}$ & 
  Compares the number of shared speces to the mean number of species in a single assemblage (local view) \\
  \\ [-1.5ex]
  \hline
  \end{tabular}
  \end{center}

Where *a* = the number of shared speces, *b* = the number of unique species in the first assemblage, and *c* = the number of unique species in the second assemblage.

***Question 4***: What are the differences between Jaccard and Sørensen metrics? When might you use one instead of the other? In what situations would these measures of $\beta$ diversity fail?

> ***Answer 3a***:  
> ***Answer 3b***:
> ***Answer 3c***:

*Notes on incidence-based similarity*: These are just two of the many incidence-based similarity measures. Others (including Ochiai, Kulczynski-Cody, and Lennon) are including in table 6.1 of Magurran & McGill 2011. The difference in these measures include how means are calculated (Sorensen = harmonic mean, Ochiai = geometric mean, and Kulcynski-Code = arithmetic mean), and how unique species are dealt with if only one sample has unique species (Lennon). However, though the two measures we have provided are the most commonly seen in the literature, we encourage you to read more about these other measures. 

Also, it is important to note that these equations calculate similarity, but can (and in many cases should) be converted to dissimilarity (D). 
In `vegan`, disimilarities (*D*) are usually returnd from functions instead of similarities (*S*).
The conversion between similarity and dissimilarity is calculated as `D = 1 - S`.

### B.  Abundance-Based Measures of Similarity and Dissimilarity

\begin{center}
\begin{tabular}{ m{2.5cm} m{5.5cm} m{6.5cm} }
  \textbf{Index} & \textbf{Equation} & \textbf{Properties} \\ 
  \hline \hline \\ [-1.5ex]
  \raggedright Bray-Curtis Dissimilarity &
  $D_{14} = \frac{\sum\limits_{j=1}^{p} \left|{y_{1j} - y_{2j}} \right|}{\sum\limits_{j = 1}^{p}\left(y_{1j} + y_{2j}\right)}$  &
  A quantitative version of the Sørensen index. Semimetric. Generally used as an overall similarity measure. Also known as the *percentage difference* \\
  \\ [-1.5ex]
  \raggedright Morisita-Horn &
  $S_{MH} = \frac{2 \sum\limits_{j=1}^{p} y_{1j}y_{2j}}{\left(\sum\limits_{j=1}^{p}y_{1j}^{2} + \sum\limits_{j=1}^{p} y_{2j}^{2}\right)}$ &
  A measure of *compositional overlap*. Uses squared differences in relative abundance and thus most influenced by more abundant species. Resistant to undersampling. \\
  \\ [-1.5ex]
  \hline
  \end{tabular}
  \end{center}

Where $y_{1j}$ is the abundance of each species (1:p) in site 1 and $y_{2j}$ in site 2, $y_{1+}$ is the sum of abundances in site 1 and $y_{2+}$ in site 2, $y_{++}$ is the sum of all abuncances across all sites, $y_{+j}$ is the sum of abundances of the $j^{th}$ species across sites, and $y_{ij}/y_{i+}$ is the relative abundances at site $i$. 

As with incidence based measures, these are just a few of the many options for calculating similarity or dissimilarity between communities. 

### C.  Other Measures Measures of Similarity and Dissimilarity (Distance) 

*Note*: some of the metrics below may not be appropriate for species abundances

***Euclidean Distance***: 
$D_{1} = \sqrt{\sum\limits_{j =1}^{p} \left( y_{1j} - y_{2j} \right)^{2}}$

***Manhattan Distance***: 
$D_{7} = \sum\limits_{j = 1}^{p} \left| y_{ij} - y_{2j} \right|$

These distance measures have been developed for and widely used to compare quantitative discriptors.
However, in general, they should not be used for abundance based data.
This is because they lead to the *Species Abundance Paradox*: the distance between two sites that have no species in common is smaller than the distance between sites with shared species.
However, methods exist to transform data prior to measuring distance and these may be appropriate for species abundance data. 
It is recommended that you read more about these distance measures if you are interested in implementing them to address your research questions.

\begin{center}
\begin{tabular}{ m{2.5cm} m{5.5cm} m{6.5cm} }
  \textbf{Index} & \textbf{Equation} & \textbf{Properties} \\ 
  \hline \hline \\ [-1.5ex]
  Chord Distance & 
  $D_3 = \sqrt{2\left(1 - \frac{\sum\limits_{j=1}^{p}y_{1j} \cdot  y_{2j}}{\sum\limits_{j=1}^{p}y_{1j}^{2} \cdot \sum\limits_{j=1}^{p} y_{2j}^{2}}\right)}$ &
  Range: 0 to $\sqrt{2}$ (from "two sites share the same species in the same proportions" to "no species in common") \\
  \\ [-1.5ex]
  \raggedright Chi-Squared Distance & 
  $D_{16} = \sqrt{\sum\limits_{j = 1}^{p} \frac{1}{y_{+j}/y_{++}} \left( \frac{y_{1j}}{y_{1+}} - \frac{y_{2j}}{y_{2+}} \right)^2}$ &
  Used to compute the association between the rows and columns of a frequency table. Preserved in correspondence analysis.  \\
  \\ [-1.5ex]
  \hline
  \end{tabular}
  \end{center}
  
Where $y_{1j}$ is the abundance of each species (1:p) in site 1 and $y_{2j}$ in site 2, $y_{1+}$ is the sum of abundances in site 1 and $y_{2+}$ in site 2, $y_{++}$ is the sum of all abuncances across all sites, $y_{+j}$ is the sum of abundances of the $j^{th}$ species across sites, and $y_{ij}/y_{i+}$ is the relative abundances at site $i$. 
  
### D.  Constructing the Resemblance Matrix

Conveniently, `vegan` has many of the similarity metrics used to construct a resemblance matrix using the function `vegdist()`.
Let's apply `vegdist` to the fish assemblages in the Doubs River (`doubs`) with the exception of site 8, which had no observations.

```{r}
fish <- doubs$fish 

rowSums(fish)    
fish <- fish[-8, ]               # Remove Site 8 From Data

# Calculate Jaccard 
fish.dj <- vegdist(fish, method="jaccard", binary=TRUE)

# Calculate Bray-Curtis 
fish.db <- vegdist(fish, method="bray")
```

Now that you created a resemblance matrix, it would be nice to visualize the fish assemblages of the Doubs River. 
As a start, we can print the resemblance matrix:

```{r, results='hide'}
fish.db
```

If you run this command in your console, you will see a large diagonal matrix. 
Typically, resemblance matrices usually just show the upper or lower triangle of values.
This is because the two triangles will have the same information.
However, you can generate a square resemblance matrix with the following command:

```{r}
fish.db <- vegdist(fish, method="bray", upper=TRUE, diag=TRUE)
```

***Question 5***: Does the resemblance matrix (`fish.db`) represent similarity or dissimilarity? How do you know?

> ***Answer 5***: 

## 5) VISUALIZING BETA-DIVERSITY

### A.  Heatmaps
One way to visualize $\beta$-diversity is to plot the data in our resemblance matrix using a **heatmap**.
Heatmaps are a two-dimensional, color representation of a data matrix. 
R has various heatmap functions.
Here we are going to use the `levelplot()` function in the `lattice` package of R.
This function will allow us to make a basic heatmap of our resemblance matrix.
However, first there are a few things we need to do:
1. We need to define a color palette.
R include many predefined color palettes; however, we are going to make our own color palette.
2. We need to make sure that our resemblance matrix is plotted in the correct order. 
By default this will not happen so we have to force it to be in the order we want. 

```{r}
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", 
                                 "#7FFF7F", "yellow", "#FF7F00", "red", 
                                 "#7F0000"))
order <- rev(attr(fish.db, "Labels"))  # Allows us to flip the heatmap to look like RM
levelplot(as.matrix(fish.db)[, order], aspect = "iso", col.regions = jet.colors, 
          xlab="Doubs Site", ylab = "Doubs Site", main = "Bray-Curtis Distance")
```

### B.  Cluster Analysis
Another common way to visualize $\beta$-diversity is to use clustering.
Clustering is technique that places objects in groups based on their similarity to one another.  
Cluserting is generally considered an exploratory technique, although there are ways to test whether certain clusters are statistically different from others. 
In this exercise, we will use hierarchical clustering, specifically Ward Clustering. 
However, there are numerous methods for clustering, which can influence your conclusions.  
See chapter 8 of Legendre and Legendre (2012) for more information on clustering
***perhaps another sentence on Ward Clustering would be useful? -- JTL***
***also, not sure if people will follow what's being done below...or more importantly why -- JTL**
***Perhaps we need to explain how to interpret "height"? -- JTL***

```{r}
fish.upgma <- hclust(fish.db, method="average")
fish.ward <- hclust(fish.db, method="ward.D")
fish.ward$height <- sqrt(fish.ward$height)  # Square Root Transformation of Branch Lengths for Visualization
plot(fish.upgma)
plot(fish.ward)
```

***Question 6***: Based on this clustering analysis, what hypotheses could be addressed with these data?
***Hard to say. Maybe some of the intuition of the data was lost by cutting out first part of visualization. Need to know something about the numbers of the sites, presumably low are upstream and higher number are downstream? -- JTL***

> ***Answer 6***: 

***Any value in showing them this, too? Segue into cluster anaylysis? -- JTL***
```{r}
heatmap(as.matrix(doubs$fish))
```

### C.  Ordination
Ordination is a statistical technique that is used for visualizing objects (e.g., sites) when there are multiple observations (e.g., species within sites). 
When objects are plotted (usually in two or three diemnsions or "axes"), ordination can be useful for determining similarity among objects. 
Using a biodiversity example, sites that are closer in ordination space have species assemblages that are more similar to one another than sites that are further apart in ordination space.  

There are various orditnation techniqeus that can be applied to multivariate biodiversity data. 
Carefuly consideration should be given to the data type (continuous vs. categorical), model assumptions, and the underlying mathematical procedures that are invovled. 

In this exercise, we focus on one commonly used ordination technique: **Principal Coordainates Analysis (PCoA)**, which is sometimes referred to as metric (multidimensional) scalling. 
PCoA starts with creating a dissimilarity (i.e., resemblance) matrix, **`D`**, from a site-by-species matrix. 
Next, **`D`** is transformed as follows: $A = - \frac{1}{\bar{2}} D^2_{ij}$ where ${ij}$ refer to the elments in **`D`**.
After centering **`A`**, PCoA is solved through eigenanlaysis, which generates eigenvectors corresponding to each ordination axis and an associated eigenvalue. 

*Notes on PCoA* A nice feature of PCoA is that it can accept many different types of resemblance matrices. 
This flexibilty can be important for emphasizing or deemphasizing certain attributes of a data set (e.g., rare vs. commmon species).
When one uses a Eucldean distance matrix with PCoA, the results are identical to that of Principal Components Analysis (PCA).

We are going to revisit the soil bacteria data set that we introduced in the $\alpha$-diversity excercise. 

```{r}                                 
soilbac.total <- read.table("./data/soilbacfull.txt", sep = "\t", header = TRUE, row.names = 1)
soilbac.tax <- (t(soilbac.total[,1:5]))
soilbac <- as.data.frame(t(soilbac.total[,6:ncol(soilbac.total)]))
```

To conduct a PCoA, first we will create a Bray-Curtis dissimilarity matrix from the site-by-species matrix (`soilbac`).
Then we will use the `cmdscale` function from the `stats` package in R, which performs "classical metric multidimensional scaling"

```{r}
soilbac.bray <- vegdist(soilbac, method="bray")
soilbac.pcoa <- cmdscale(soilbac.bray, eig=TRUE) 
```

Now we will use some of the plotting packages in `vegan` to visualize the ordination. 

```{r}
ordiplot(scores(soilbac.pcoa)[,c(1,2)], type='t', main="PCoA with taxa")
abline(h=0, lty=3)
abline(v=0, lty=3)
```

***Question 7***: As you will recall, soil bacteria were sampled from four different replicated land-use treatments (T1 = agriculture, T7 = grassland, DF = deciduous fores, and CF = conifersou forest). 
Based on the PCoA ordination, describe the effects of land-use on soil bacterial $\beta$-diversity? 

> ***Answer 7***: 

In PCoA, we can quantify the amount of variation that is explained by each orthogonal axis.
It can give us an overall sense of how much "singal" is our data set if for example we sampled along some predetermined enviornmental gradient. 
This is not something that can be done in all ordination methods. 
We can estimate variance explained by dividing the eigenvalue of each axis by the sum of all eigenvalues. 
*Note*: in PCoA and other ordination techniques, the first axis explains the most variation, follwed by the second, third, etc.

```{r}
explainvar1 <- soilbac.pcoa$eig[1]/sum(soilbac.pcoa$eig)
explainvar2 <- soilbac.pcoa$eig[2]/sum(soilbac.pcoa$eig)
```

In the PCoA plot that you just created, we are looking at the relationship of samples in species space. 
Differences in species abundances are contributing the separation of samples along each PCoA axis. 
We can gain some insight into "who" is responsible for this separation by examining the correlation between the site scores and the species vectors. 
We will obtain this information using the `add.spec.scores` function in the R `BiodiversityR` package, which we will now load. 

```{r}
require(BiodiversityR)
# soilbac.pcoa.corr <- add.spec.scores(soilbac.pcoa, soilbac, method = "cor.scores", Rscale = TRUE, scaling = 1, multi = 1)
# corr.spp <- cbind.data.frame(t(soilbac.tax), soilbac.pcoa.corr$cproj[,1], soilbac.pcoa.corr$cproj[,2]) 
# corr.spp <- corr.spp[order(corr.spp[,6],decreasing=TRUE),] # sorts based on r of PCoA axis 1
# colnames(cor_spp)[6]<-"Corr1"
# colnames(cor_spp)[7]<-"Corr2"
# corrcut <- 0.7
# imp.spp.axis1 <- corr.spp[corr.spp[,6] >= corrcut | corr.spp[,6] <= -corrcut,]
# imp.spp.axis2 <- corr.spp[corr.spp[,7] >= corrcut | corr.spp[,7] <= -corrcut,]
```

***Question 7***: Using the `add.spec.scores` function, can you generate any hypotheses about what soil bacterial taxa are potential indicators of land-use variation? 

> ***Answer 7***: 

## 6) HYPOTHESIS TESTING

Some of the visualization tools that we just learned about are powerful for exploring data sets and generating hypotheses, but  can fall short of providing robust tests of *a priori* hypotheses and predictions. 
Here, we wil introduce a few techniques that are appropriate for testing hypotheses that you might have when using multivariate data and are interested in questions related to $\beta$-diversity. 

### A.  Multivariate procedures for categorical designs

PERMANOVA stands for permutational multivariate analysis of variance. 
It is a multivariate analog to univariate ANOVA and has less restrictions than parametric multivariate analysis of variance (MANOVA). 
As the name suggests, it evaluates differences according to your specified model by randomly permuting the data.
PERMANOVA can easily handle simple designs, but also accomodates nested and higher-order studies. 
It can handle missing observations and supplies output such as F ratios, pseudo P-values, and R^{2} values.
We will implement PERMANOVA with the `adonis` function in the `vegan` package. 

To run `adonis`, you need to import a "factors" table, which specifies your treatments and replicates. 
There are actually two treatments associated with the `soilbac` data set. 
The first is the land-use factor, which has already been introduced. 
The other factor is watering treatment. 
Half the soil samples were characterized when they were very dry, and the other half were characterized three days after being watered.
So, in the end, we have a two-by-two full factorial design (with the exception of one missing sample from the DF land-use treatment)

Let's import our factors table associated with `soilbac`. 

```{r}
factors <- read.table("./data/soil.factors.txt" , sep = "\t", header=TRUE) 
```

Now, we can run `adonis` on the `soilbac` site-by-species matrix, but we also need to specify the model, the number of permutations, and the dissimilarity metric that we want to use to create a resemblance matrix. 

```{r}
soil.adonis <-adonis(soilbac ~ land + time + land*time, factors, permutations = 999, method = "bray") 
```

***Question 8***: Using the output of the PERMANOVA model, interpret the resuls of the experiment that generated the `soilbac` data set. 

> ***Answer 8***: 


### B.  Mutivariate procedures for continuous designs

### i.  Mantel test
A **Mantel test** is essentially a multivariate correlation analysis. 
It produces an *r* value that is analagous to the Pearson's correlation coefficient. 
The p-value from the Mantel test is derived from the deviation of observed correlation to that of correlations derived from randomizations of the two matrices. 

In the following section, we will peform a Mantel test using the `mantel` function in `vegan`. 
This requires that we first create a distance matrix for each of our raw matrices. 
After creating the distance matrices, we will test the hypotheses that 1) fish assemblages are correlated with stream environmental variables, and 2) fish assemblages are correlated with geographic location.

```{r}
fish.dist <- vegdist(doubs$fish[-8, ], method = "bray")
env.dist <- vegdist(scale(doubs$env[-8,]),method = "euclid")
geo.dist <- vegdist(doubs$xy[-8,], method = "euclid")
mantel(fish.dist,env.dist)
mantel(fish.dist,geo.dist)
```

The results from our Mantel tests suggest that fish diversity is correlated with stream environmental conditions *and* geographic location. 
We can try to tease this relationship apart by conducting a **partial Mantel test**. 
In this type of an analysis, we can look for a correlation between two matrices while "controlling" for a third matix. 
For our example, we will look for correlations between fish assemblage and the stream environment, while holding geography constant. 

```{r}
mantel.partial(fish.dist, env.dist, geo.dist, method = "pearson", permutations = 999)
```

***Question 9***: What conclusions can you draw about the effects of geography and environmental conditions on the $\beta$-diversity of fish in the Doubs River based on the results of the Mantel tests above?

> ***Answer 9***: 

## 7) HOMEWORK

1.  We are going to revsit the soil bacteria data set from the $\alpha$-diversity exercise. 
You may recall that 16S rRNA sequences were generated from replicate sites from four different land-use treatments (T1 = agriculture, T7 = grassland, DF = deciduous forest, and CF = coniferous forest). 
On top of this, we characterized bacteria from the above soils under dry vs. wet condtions. 
Thus, we have a 2 x 2 full factorial design (with the exception of a missing sample from the DF land-use treatment). 
More background on this study can be found in Aanderud et al. 2015 (http://goo.gl/TRgISq)

Two files are available to you in the "~/Assignments/Beta/data"" directory:

a.  Site-by-species matrix ("soilbacfull.txt")
b.  Factors file describing the treatments ("soil.factors.txt")

Use a combination of visualization and hypothesis-testing techniques described above, interpret the results from the exepriment in a $\beta$-diversity framework. 

2.  Use Knitr to create a pdf of your completed alpha_exercise.Rmd document, push it to GitHub, and create a pull request.
The due date for this assignment will be announced in class and/or canvas.













***Not sure what we want to do with the following section  -- JTL***
### Constrained Ordination

```{r}
# subset explanatory varaibles


# 
# envdas <- env[,1]
# envtopo <- env[,c(2:4)]
# envchem <- env[,c(5:11)]
# spe.hel <- decostand(spe, method="hellinger")
# 
# spe.rda <- rda(spe.hel ~ ., envchem)
# coef(spe.rda)
# 
# spechem.physio <- rda(spe.hel, envchem, envtopo)
# 
# # PermutationTest
# anova.cca(spe.rda, step=1000)
```

### Multivariate Models
Mantel Test --> could be useful

PERMANOVA --> on soilbac data

CCA --> could be done on Doubs or introduce BCI/BCIsoils







