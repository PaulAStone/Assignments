---
title: "Among Site (Beta) Diversity"
author: "Z620: Quantitative Biodiversity, Indiana University"
date: "February 6, 2015"
header-includes:
   - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

## OVERVIEW
In the last exercise, we explored within-site or $\alpha$-diversity of a community.
However, community ecologists are often interested in the spatial or temporal variation in community composition. 
To understand this variation, we will partition regional diversity (aka $\gamma$-diversity) into within- ($\alpha$) and between- ($\beta$) site diversity. 
As such, $\beta$-diversity represents the compositional similarity and differentiation between sites. 

In this exercise, we will explore between-site biodiversity, also known as beta ($\beta$) diversity. 
During this processs you will learn how to:

1. formally quantify $\beta$-diversity
2. visualize $\beta$-diversity with heatmaps, cluster analysis, and ordination
3. test hypotheses about $\beta$-diversity using multivariate statistics

## 1) SETUP
### Retrieve and Set Your Working Directory

```{r, results = 'hide'}
rm(list=ls())
getwd()
setwd("~/GitHub/QuantitativeBiodiversity/Assignments/Beta")
```

### Load Packages 

We will be using the `vegan` package again; let's load it now. 

```{r, results = 'hide', message = FALSE, warning = FALSE} 
require("vegan")
```

## 2) LOADING DATA

So far we have explored data related to zooplankton biomass, tree abundances at Barro-Colorado Island (BCI), and soil bacteria from plots in the KBS Long-Term Ecological Site (http://lter.kbs.msu.edu/).
This week we will be a new dataset; however, we will use the soil bacteria data that we used for $\alpha$-diversity for homework.
This week we will primarily be using a fish data set from the `ade4` package for our exercise.
This data set (`doubs`) includes fish abundances, environmental variables, and spatial cooridinates for 30 sites in the Doubs River.
The Doubs River runs near the France-Switzerland boarder in the Jura Mountains.
This data set has been used to show that fish communities can be a good indicator of ecological zones in rivers and streams. 
Let's load the `ade` package and the `doubs` data set. 

```{r}
require(ade4)
data(doubs)
```

*Note on `doubs`*: While working in R this semester, we have learned about different data structures, including vectors, matrices, and data frames. 
Now, we are working with yet another data structure: a **list**. 
In R, a list is an object that contains a collection of other objects of similar or different types.

We can use the `str()` function to describe some of the attributes of `doubs`.
Because this dataset is complex, we can pass the "max.level = 1" arguement to minimize the output of `str()`

```{r, results='hide'}
str(doubs, max.level = 1)
```

***Question 1***:  Describe some of the attributes of the `doubs` dataset. 
Also, you can use the dollar sign (`$`) between the list name (`doubs`) and objects within the list (`env`).
In addition, always remember that you can find additional information using the `help()` function.
a.  How many objects are in `doubs` list?
b.  What types of data structures are used in the `doubs` list?
c.  What are the units of nitrate ("nit") in the stream water?
d.  How many fish species are there in the `doubs` list?

> ***Answer 1a***:  
> ***Answer 1b***:  
> ***Answer 1c***:  
> ***Answer 1d***:  

## 3) QUANTIFYING BETA-DIVERSITY BETWEEN TWO SAMPLES

In this section we introduce a relatively simple measure of $\beta$-diversity: **Whittaker's** $\pmb\beta$-**Diversity**.
This index allow us to estimate $\beta$-diversity between samples. 
Whittaker's $\beta$ is a classic measure of $\beta$-diversity and was developed by Robert Whittaker (1960). 
The equation for Whittaker's $\beta$ is as follows:
$\beta_{W} = \frac{S}{\bar{\alpha}} - 1$ 
where *S* = the total number of species recorded in a system (i.e., $\gamma$-diversity) and $\bar{\alpha}$ which is the mean sample richness (i.e., $\alpha$ diversity).
Subtracting 1 scales $\beta_{w}$ from 0 (minimum $\beta$-diversity) to 1 (maximum $\beta$-diversity).

We can write this as a function in R:

```{r}
beta.w <- function(site1 = "", site2 = ""){
  site1 = subset(site1, select = site1 > 0)               # Removes absences
  site2 = subset(site2, select = site2 > 0)               # Removes absences
  gamma = union(colnames(site1), colnames(site2))         # Gamma species pool
  s     = length(gamma)                                   # Gamma richness
  a.bar = mean(c(specnumber(site1), specnumber(site2)))   # Avg sample richness
  b.w   = round(s/a.bar - 1, 3)
  return(b.w)
}

fish <- doubs$fish
b <- beta.w(fish[1,], fish[2, ])
```

***Question 2***: Using the `beta.w` function above, what is the $\beta$-diversity for fish sampled from site 1 and site 2 of the `doubs` data set? Based on the formula for $\beta_{w}$, what does this value represent?

> ***Answer 2a***: 
> ***Answer 2b***: 

## 4) QUANTIFYING BETA-DIVERSITY FOR TWO OR MORE SAMPLES

Often, we often want to compare the diversity of more than just a pair of samples. 
In this section we will estimate $\beta$-diversity for multiple samples. 
During this process, you will learn how to generate similarity and dissimilarity matrices for different data sets that will be needed for visualizing and quantifying $\beta$-diversity. 

### Resemblance Matrix
Here, we introduce our second primary ecological data structure: the **Resemblance Matrix**. 
In the context of biodiversity, a resemblance matrix is a data structure that calculates the pairwise **similarity** or **dissimiliarity** for all samples in a site-by-species matrix. 
The resemblance matrix can be generated from a site-by-species matrix containing incidence (presence-absence) data or abundance data. 
In the sections below, we describe some of the common similarity and dissimilarity metrics used for constructing a resemblance matrix.
Through out this handout, we will use common notations in accordance with Legendre & Legendre (2012). 

### A.  Incidence-Based Measures of Similarity and Dissimilarity

\begin{center}
\begin{tabular}{ m{2.5cm} m{5.5cm} m{6.5cm} }
  \textbf{Index} & \textbf{Equation} & \textbf{Properties} \\
  \hline \hline \\ [-1.5ex]
  Jaccard & 
  $S_7 = \frac{a}{a+b+c}$ & 
  Compares the number of shared species to the number of species in the combined assemblages  (global view ) \\
  \\ [-1.5ex]
  Sørensen & 
  $S_8 = \frac{2a}{(2a+b+c)}$ & 
  Compares the number of shared speces to the mean number of species in a single assemblage (local view) \\
  \\ [-1.5ex]
  \hline
  \end{tabular}
  \end{center}

Where *a* = the number of shared speces, *b* = the number of unique species in the first assemblage, and *c* = the number of unique species in the second assemblage.

***Question 4***: What are the differences between Jaccard and Sørensen metrics? When might you use one instead of the other? In what situations would these measures of $\beta$ diversity fail?

> ***Answer 3a***:  
> ***Answer 3b***:
> ***Answer 3c***:

*Notes on incidence-based similarity*: These are just two of the many incidence-based similarity measures. Others (including Ochiai, Kulczynski-Cody, and Lennon) are including in table 6.1 of Magurran & McGill 2011. The difference in these measures include how means are calculated (Sorensen = harmonic mean, Ochiai = geometric mean, and Kulcynski-Code = arithmetic mean), and how unique species are dealt with if only one sample has unique species (Lennon). However, though the two measures we have provided are the most commonly seen in the literature, we encourage you to read more about these other measures. 

Also, it is important to note that these equations calculate similarity, but can (and in many cases should) be converted to dissimilarity (D). 
In `vegan`, disimilarities (*D*) are usually returnd from functions instead of similarities (*S*).
The conversion between similarity and dissimilarity is calculated as `D = 1 - S`.

### B.  Abundance-Based Measures of Similarity and Dissimilarity

\begin{center}
\begin{tabular}{ m{2.5cm} m{5.5cm} m{6.5cm} }
  \textbf{Index} & \textbf{Equation} & \textbf{Properties} \\ 
  \hline \hline \\ [-1.5ex]
  \raggedright Bray-Curtis Dissimilarity &
  $D_{14} = \frac{\sum\limits_{j=1}^{p} \left|{y_{1j} - y_{2j}} \right|}{\sum\limits_{j = 1}^{p}\left(y_{1j} + y_{2j}\right)}$  &
  A quantitative version of the Sørensen index. Semimetric. Generally used as an overall similarity measure. Also known as the *percentage difference* \\
  \\ [-1.5ex]
  \raggedright Morisita-Horn &
  $S_{MH} = \frac{2 \sum\limits_{j=1}^{p} y_{1j}y_{2j}}{\left(\sum\limits_{j=1}^{p}y_{1j}^{2} + \sum\limits_{j=1}^{p} y_{2j}^{2}\right)}$ &
  A measure of *compositional overlap*. Uses squared differences in relative abundance and thus most influenced by more abundant species. Resistant to undersampling. \\
  \\ [-1.5ex]
  Chord Distance & 
  $D_3 = \sqrt{2\left(1 - \frac{\sum\limits_{j=1}^{p}y_{1j} \cdot  y_{2j}}{\sum\limits_{j=1}^{p}y_{1j}^{2} \cdot \sum\limits_{j=1}^{p} y_{2j}^{2}}\right)}$ &
  Range: 0 to $\sqrt{2}$ (from "two sites share the same species in the same proportions" to "no species in common") \\
  \\ [-1.5ex]
  \raggedright Chi-Squared Distance & 
  $D_{16} = \sqrt{\sum\limits_{j = 1}^{p} \frac{1}{y_{+j}/y_{++}} \left( \frac{y_{1j}}{y_{1+}} - \frac{y_{2j}}{y_{2+}} \right)^2}$ &
  Used to compute the association between the rows and columns of a frequency table. Preserved in correspondence analysis.  \\
  \\ [-1.5ex]
  \hline
  \end{tabular}
  \end{center}

Where $y_{1j}$ is the abundance of each species (1:p) in site 1 and $y_{2j}$ in site 2, $y_{1+}$ is the sum of abundances in site 1 and $y_{2+}$ in site 2, $y_{++}$ is the sum of all abuncances at all sites, $y_{+j}$ is the sum of abundances of the $j^{th}$ species across sites, and $y_{ij}/y_{i+}$ is the relative abundances at site $i$. 

As with incidence based measures, these are just a few of the many options for calculating 

### C.  Other Measures Measures of Similarity and Dissimilarity 

*Note*: some of the metrics below may not be appropriate for species abundances

Euclidean Distance: 
$D_{1} = \sqrt{\sum\limits_{j =1}^{p} \left( y_{1j} - y_{2j} \right)^{2}}$

Manhattan Metric: 
$D_{7} = \sum\limits_{j = 1}^{p} \left| y_{ij} - y_{2j} \right|$

These metric distance measures have been developed for and widely used to compare quantitative discriptors.
However, in general, they should not be used for abundance based data.
This is because they lead to the *Species Abundance Paradox*: the distance between two sites that have no species in common is smaller than the distance between sites with shared species. 
  
### D.  Constructing the Resemblance Matrix
Conveniently, `vegan` has many of the similarity metrics used to construct a resemblance matrix using the function `vegdist()`.
Let's apply `vegdist` to the fish assemblages in the Doubs River (`doubs`) with the exception of site 8, which had no observations.

```{r}
fish <- doubs$fish 

rowSums(fish)    
fish <- fish[-8, ]

# Calculate Jaccard 
fish.dj <- vegdist(fish, method="jaccard", binary=TRUE)

# Calculate Bray-Curtis 
fish.db <- vegdist(fish, method="bray")
```

Now that you created a resemblance matrix, it would be nice to visualize the fish assemblages of the Doubs River. 
As a start, we can print the resemblance matrix:

```{r, results='hide'}
fish.db
```

If you run this command in your console, you will see a large diagonal matrix. 
Typically, resemblance matrices usually just show the upper or lower triangle of values.
This is because the two triangles will have the same information.
However, you can generate a square resemblance matrix with the following command:

```{r}
fish.db <- vegdist(fish, method="bray", upper=TRUE, diag=TRUE)
```

*** Wording of this question raises questions abou the distinction between distance and dissimilarity -- JTL**
***Question 5***: Does the resemblance matrix (`fish.db`) represent similarity or distance? How do you know?

> ***Answer 5***: 

## 5) VISUALIZING BETA-DIVERSITY

### A.  Heatmaps
One way to visualize $\beta$-diversity is to plot the data in our resemblance matrix using a **heatmap**.
Heatmaps are a two-dimensional, color representation of a data matrix. 
R has various heatmap functions.
Here we are going to use the `levelplot()` function in the `lattice` package of R.
We will define our own color palette, and custom order our matrix so that our plot looks like a resemblance matrix. 

```{r}
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
order <- rev(attr(fish.db, "Labels"))          # Allows us to flip the heatmap to look like RM
levelplot(as.matrix(fish.db)[, order], aspect = "iso", col.regions = jet.colors, xlab="Doubs Site", ylab = "Doubs Site", main = "Bray-Curtis Distance")
```

***Any value in showing them this, too? Segue into cluster anaylysis? -- JTL***
```{r}
heatmap(as.matrix(doubs$fish))
```

### B.  Cluster Analysis
Another common way to visualize $\beta$-diversity is to use clustering.
Clustering is technique that places objects in groups based on their similarity to one another.  
Cluserting is generally considered an exploratory technique, although there are ways to test whether certain clusters are statistically different from others. 
In this exercise, we will use hierarchical clustering, specifically Ward Clustering. 
However, there are numerous methods for clustering, which can influence your conclusions.  
See chapter 8 of Legendre and Legendre (2012) for more information on clustering
***perhaps another sentence on Ward Clustering would be useful? -- JTL***
***also, not sure if people will follow what's being done below...or more importantly why -- JTL**
***Perhaps we need to explain how to interpret "height"? -- JTL***

```{r}
fish.norm <- decostand(fish, "normalize")         # Two step process to calculate chord distances
fish.ch <- vegdist(fish.norm, "euc")
fish.ch.ward <- hclust(fish.ch, method="ward.D")
fish.ch.ward$height <- sqrt(fish.ch.ward$height)  # Square Root Transformation of Branch Lengths for Visualization
plot(fish.ch.ward)
```

***Question 6***: Based on this clustering analysis, what hypotheses could be addressed with these data?
***Hard to say. Maybe some of the intuition of the data was lost by cutting out first part of visualization. Need to know something about the numbers of the sites, presumably low are upstream and higher number are downstream? -- JTL***

> ***Answer 6***: 

### C.  Ordination
Ordination is a statistical technique that is used for visualizing objects (e.g., sites) when there are multiple observations (e.g., species within sites). 
When objects are plotted (usually in two or three diemnsions or "axes"), ordination can be useful for determining similarity among objects. 
Using a biodiversity example, sites that are closer in ordination space have species assemblages that are more similar to one another than sites that are further apart in ordination space.  

There are various orditnation techniqeus that can be applied to multivariate biodiversity data. 
Carefuly consideration should be given to the data type (continuous vs. categorical), model assumptions, and the underlying mathematical procedures that are invovled. 

In this exercise, we focus on one commonly used ordination technique: **Principal Coordainates Analysis (PCoA)**, which is sometimes referred to as metric (multidimensional) scalling. 
PCoA starts with creating a dissimilarity (i.e., resemblance) matrix, **`D`**, from a site-by-species matrix. 
Next, **`D`** is transformed as follows: $A = - \frac{1}{\bar{2}} D^2_{ij}$ where ${ij}$ refer to the elments in **`D`**.
After centering **`A`**, PCoA is solved through eigenanlaysis, which generates eigenvectors corresponding to each ordination axis and an associated eigenvalue. 

*Notes on PCoA* A nice feature of PCoA is that it can accept many different types of resemblance matrices. 
This flexibilty can be important for emphasizing or deemphasizing certain attributes of a data set (e.g., rare vs. commmon species).
When one uses a Eucldean distance matrix with PCoA, the results are identical to that of Principal Components Analysis (PCA).

We are going to revisit the soil bacteria data set that we introduced in the $\alpha$-diversity excercise. 

```{r}                                 
soilbac.total <- read.table("./data/soilbacfull.txt", sep = "\t", header = TRUE, row.names = 1)
soilbac.tax <- (t(soilbac.total[,1:5]))
soilbac <- as.data.frame(t(soilbac.total[,6:ncol(soilbac.total)]))
```

To conduct a PCoA, first we will create a Bray-Curtis dissimilarity matrix from the site-by-species matrix (`soilbac`).
Then we will use the `cmdscale` function from the `stats` package in R, which performs "classical metric multidimensional scaling"

```{r}
soilbac.bray <- vegdist(soilbac, method="bray")
soilbac.pcoa <- cmdscale(soilbac.bray, eig=TRUE) 
```

Now we will use some of the plotting packages in `vegan` to visualize the ordination. 

```{r}
ordiplot(scores(soilbac.pcoa)[,c(1,2)], type='t', main="PCoA with taxa")
abline(h=0, lty=3)
abline(v=0, lty=3)
```

***Question 7***: As you will recall, soil bacteria were sampled from four different replicated land-use treatments (T1 = agriculture, T7 = grassland, DF = deciduous fores, and CF = conifersou forest). 
Based on the PCoA ordination, describe the effects of land-use on soil bacterial $\beta$-diversity? 

> ***Answer 7***: 

In PCoA, we can quantify the amount of variation that is explained by each orthogonal axis.
It can give us an overall sense of how much "singal" is our data set if for example we sampled along some predetermined enviornmental gradient. 
This is not something that can be done in all ordination methods. 
We can estimate variance explained by dividing the eigenvalue of each axis by the sum of all eigenvalues. 
*Note*: in PCoA and other ordination techniques, the first axis explains the most variation, follwed by the second, third, etc.

```{r}
explainvar1 <- soilbac.pcoa$eig[1]/sum(soilbac.pcoa$eig)
explainvar2 <- soilbac.pcoa$eig[2]/sum(soilbac.pcoa$eig)
```

In the PCoA plot that you just created, we are looking at the relationship of samples in species space. 
Differences in species abundances are contributing the separation of samples along each PCoA axis. 
We can gain some insight into "who" is responsible for this separation by examining the correlation between the site scores and the species vectors. 
We will obtain this information using the `add.spec.scores` function in the R `BiodiversityR` package, which we will now load. 

```{r}
require(BiodiversityR)
# soilbac.pcoa.corr <- add.spec.scores(soilbac.pcoa, soilbac, method = "cor.scores", Rscale = TRUE, scaling = 1, multi = 1)
# corr.spp <- cbind.data.frame(t(soilbac.tax), soilbac.pcoa.corr$cproj[,1], soilbac.pcoa.corr$cproj[,2]) 
# corr.spp <- corr.spp[order(corr.spp[,6],decreasing=TRUE),] # sorts based on r of PCoA axis 1
# colnames(cor_spp)[6]<-"Corr1"
# colnames(cor_spp)[7]<-"Corr2"
# corrcut <- 0.7
# imp.spp.axis1 <- corr.spp[corr.spp[,6] >= corrcut | corr.spp[,6] <= -corrcut,]
# imp.spp.axis2 <- corr.spp[corr.spp[,7] >= corrcut | corr.spp[,7] <= -corrcut,]
```

***Question 7***: Using the `add.spec.scores` function, can you generate any hypotheses about what soil bacterial taxa are potential indicators of land-use variation? 

> ***Answer 7***: 

## 6) HYPOTHESIS TESTING

Some of the visualization tools that we just learned about are powerful for exploring data sets and generating hypotheses, but  can fall short of providing robust tests of *a priori* hypotheses and predictions. 
Here, we wil introduce a few techniques that are appropriate for testing hypotheses that you might have when using multivariate data and are interested in questions related to $\beta$-diversity. 

### A.  Multivariate procedures for categorical designs

PERMANOVA stands for permutational multivariate analysis of variance. 
It is a multivariate analog to univariate ANOVA and has less restrictions than parametric multivariate analysis of variance (MANOVA). 
As the name suggests, it evaluates differences according to your specified model by randomly permuting the data.
PERMANOVA can easily handle simple designs, but also accomodates nested and higher-order studies. 
It can handle missing observations and supplies output such as F ratios, pseudo P-values, and R^{2} values.
We will implement PERMANOVA with the `adonis` function in the `vegan` package. 

To run `adonis`, you need to import a "factors" table, which specifies your treatments and replicates. 
There are actually two treatments associated with the `soilbac` data set. 
The first is the land-use factor, which has already been introduced. 
The other factor is watering treatment. 
Half the soil samples were characterized when they were very dry, and the other half were characterized three days after being watered.
So, in the end, we have a two-by-two full factorial design (with the exception of one missing sample from the DF land-use treatment)

Let's import our factors table associated with `soilbac`. 

```{r}
factors <- read.table("./data/soil.factors.txt" , sep = "\t", header=TRUE) 
```

Now, we can run `adonis` on the `soilbac` site-by-species matrix, but we also need to specify the model, the number of permutations, and the dissimilarity metric that we want to use to create a resemblance matrix. 

```{r}
soil.adonis <-adonis(soilbac ~ land + time + land*time, factors, permutations = 999, method = "bray") 
```

***Question 8***: Using the output of the PERMANOVA model, interpret the resuls of the experiment that generated the `soilbac` data set. 

> ***Answer 8***: 


### B.  Mutivariate procedures for continuous designs

### i.  Mantel test
A **Mantel test** is essentially a multivariate correlation analysis. 
It produces an *r* value that is analagous to the Pearson's correlation coefficient. 
The p-value from the Mantel test is derived from the deviation of observed correlation to that of correlations derived from randomizations of the two matrices. 

In the following section, we will peform a Mantel test using the `mantel` function in `vegan`. 
This requires that we first create a distance matrix for each of our raw matrices. 
After creating the distance matrices, we will test the hypotheses that 1) fish assemblages are correlated with stream environmental variables, and 2) fish assemblages are correlated with geographic location.

```{r}
fish.dist <- vegdist(doubs$fish[-8, ], method = "bray")
env.dist <- vegdist(scale(doubs$env[-8,]),method = "euclid")
geo.dist <- vegdist(doubs$xy[-8,], method = "euclid")
mantel(fish.dist,env.dist)
mantel(fish.dist,geo.dist)
```

The results from our Mantel tests suggest that fish diversity is correlated with stream environmental conditions *and* geographic location. 
We can try to tease this relationship apart by conducting a **partial Mantel test**. 
In this type of an analysis, we can look for a correlation between two matrices while "controlling" for a third matix. 
For our example, we will look for correlations between fish assemblage and the stream environment, while holding geography constant. 

```{r}
mantel.partial(fish.dist, env.dist, geo.dist, method = "pearson", permutations = 999)
```

***Question 9***: What conclusions can you draw about the effects of geography and environmental conditions on the $\beta$-diversity of fish in the Doubs River based on the results of the Mantel tests above?

> ***Answer 9***: 

## 7) HOMEWORK

1.  We are going to revsit the soil bacteria data set from the $\alpha$-diversity exercise. 
You may recall that 16S rRNA sequences were generated from replicate sites from four different land-use treatments (T1 = agriculture, T7 = grassland, DF = deciduous forest, and CF = coniferous forest). 
On top of this, we characterized bacteria from the above soils under dry vs. wet condtions. 
Thus, we have a 2 x 2 full factorial design (with the exception of a missing sample from the DF land-use treatment). 
More background on this study can be found in Aanderud et al. 2015 (http://goo.gl/TRgISq)

Two files are available to you in the "~/Assignments/Beta/data"" directory:

a.  Site-by-species matrix ("soilbacfull.txt")
b.  Factors file describing the treatments ("soil.factors.txt")

Use a combination of visualization and hypothesis-testing techniques described above, interpret the results from the exepriment in a $\beta$-diversity framework. 

2.  Use Knitr to create a pdf of your completed alpha_exercise.Rmd document, push it to GitHub, and create a pull request.
The due date for this assignment will be announced in class and/or canvas.













***Not sure what we want to do with the following section  -- JTL***
### Constrained Ordination

```{r}
# subset explanatory varaibles


# 
# envdas <- env[,1]
# envtopo <- env[,c(2:4)]
# envchem <- env[,c(5:11)]
# spe.hel <- decostand(spe, method="hellinger")
# 
# spe.rda <- rda(spe.hel ~ ., envchem)
# coef(spe.rda)
# 
# spechem.physio <- rda(spe.hel, envchem, envtopo)
# 
# # PermutationTest
# anova.cca(spe.rda, step=1000)
```

### Multivariate Models
Mantel Test --> could be useful

PERMANOVA --> on soilbac data

CCA --> could be done on Doubs or introduce BCI/BCIsoils







